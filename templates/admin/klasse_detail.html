{% extends 'base.html' %}

{% block title %}{{ klasse.name }} - Lernmanager{% endblock %}

{% block content %}
<div class="flex flex-between flex-center mb-2">
    <h1>ğŸ“ {{ klasse.name }}</h1>
    <div class="flex gap-1">
        <a href="{{ url_for('admin_topic_queue', klasse_id=klasse.id) }}" class="btn btn-secondary">ğŸ“‹ Themen-Reihenfolge</a>
        <a href="{{ url_for('admin_unterricht', klasse_id=klasse.id) }}" class="btn btn-primary">ğŸ“… Unterricht</a>
        <a href="{{ url_for('admin_klasse_bericht', klasse_id=klasse.id) }}" class="btn btn-success">ğŸ“Š Klassenbericht</a>
        <form method="POST" action="{{ url_for('admin_klasse_loeschen', klasse_id=klasse.id) }}" style="display: inline;" onsubmit="return confirm('Klasse wirklich lÃ¶schen?');">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button type="submit" class="btn btn-danger">ğŸ—‘ï¸ LÃ¶schen</button>
        </form>
    </div>
</div>

<!-- Batch Add Students -->
<div class="card mb-2">
    <div class="card-header">ğŸ‘¥ SchÃ¼ler hinzufÃ¼gen (Batch)</div>
    <form method="POST" action="{{ url_for('admin_klasse_schueler_hinzufuegen', klasse_id=klasse.id) }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="form-group">
            <label>Ein SchÃ¼ler pro Zeile: <code>Nachname, Vorname</code></label>
            <textarea name="batch_input" class="form-control" rows="5" placeholder="MÃ¼ller, Max&#10;Schmidt, Anna&#10;Weber, Tim"></textarea>
        </div>
        <button type="submit" class="btn btn-primary">HinzufÃ¼gen</button>
    </form>
</div>

<!-- Class Schedule -->
<div class="card mb-2">
    <div class="card-header">ğŸ“… WÃ¶chentlicher Unterricht</div>
    <form method="POST" action="{{ url_for('admin_klasse_schedule', klasse_id=klasse.id) }}" class="flex gap-1">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <select name="weekday" class="form-control" style="flex: 1;">
            <option value="">-- Kein regelmÃ¤ÃŸiger Termin --</option>
            <option value="0" {% if schedule and schedule.weekday == 0 %}selected{% endif %}>Montag</option>
            <option value="1" {% if schedule and schedule.weekday == 1 %}selected{% endif %}>Dienstag</option>
            <option value="2" {% if schedule and schedule.weekday == 2 %}selected{% endif %}>Mittwoch</option>
            <option value="3" {% if schedule and schedule.weekday == 3 %}selected{% endif %}>Donnerstag</option>
            <option value="4" {% if schedule and schedule.weekday == 4 %}selected{% endif %}>Freitag</option>
            <option value="5" {% if schedule and schedule.weekday == 5 %}selected{% endif %}>Samstag</option>
            <option value="6" {% if schedule and schedule.weekday == 6 %}selected{% endif %}>Sonntag</option>
        </select>
        <button type="submit" class="btn btn-primary">Speichern</button>
    </form>
    <small class="text-muted">Verwende Vor/ZurÃ¼ck-Buttons im Unterricht, um wÃ¶chentlich zu navigieren.</small>
</div>

<!-- Assign Task to Class -->
<div class="card mb-2">
    <div class="card-header">ğŸ“ Thema fÃ¼r alle zuweisen</div>
    <form method="POST" action="{{ url_for('admin_klasse_thema_zuweisen', klasse_id=klasse.id) }}" id="assign-task-form">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="flex gap-1">
            <select name="task_id" class="form-control" style="flex: 1;" required>
                <option value="">-- Thema wÃ¤hlen --</option>
                {% for task in tasks %}
                <option value="{{ task.id }}">{{ task.fach }} ({{ task.stufe }}): {{ task.name }}</option>
                {% endfor %}
            </select>
            <button type="submit" class="btn btn-primary">Zuweisen</button>
        </div>
    </form>
</div>

<!-- Set Lernpfad for whole class -->
<div class="card mb-2">
    <div class="card-header">ğŸ›¤ï¸ Lernpfad fÃ¼r alle setzen</div>
    <form method="POST" action="{{ url_for('admin_klasse_lernpfad', klasse_id=klasse.id) }}" class="flex gap-1 flex-center">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <select name="lernpfad" class="form-control" style="width: auto;">
            <option value="wanderweg">ğŸŸ¢ Wanderweg â€” Grundlagen</option>
            <option value="bergweg" selected>ğŸ”µ Bergweg â€” VollstÃ¤ndig</option>
            <option value="gipfeltour">â­ Gipfeltour â€” Alles</option>
        </select>
        <button type="submit" class="btn btn-primary" onclick="return confirm('Lernpfad fÃ¼r alle SchÃ¼ler in dieser Klasse setzen?')">FÃ¼r alle setzen</button>
    </form>
</div>

<!-- Students List -->
<div class="card">
    <div class="card-header">ğŸ‘¥ SchÃ¼ler ({{ students|length }})</div>
    {% if students %}
    <table class="table">
        <thead>
            <tr>
                <th>Name</th>
                <th>Benutzername</th>
                <th>Aktuelles Thema</th>
                <th>Status</th>
                <th>Aktionen</th>
            </tr>
        </thead>
        <tbody>
            {% for student in students %}
            <tr>
                <td>
                    <a href="{{ url_for('admin_schueler_detail', student_id=student.id) }}">
                        <strong>{{ student.nachname }}, {{ student.vorname }}</strong>
                    </a>
                </td>
                <td><code>{{ student.username }}</code></td>
                <td>
                    {% if student.task_name %}
                        {{ student.task_name }}
                        {% if student.queue_pos %}
                        <span class="text-muted">({{ student.queue_pos }}/{{ student.queue_total }})</span>
                        {% endif %}
                    {% else %}
                        <span class="text-muted">-</span>
                    {% endif %}
                </td>
                <td>
                    {% if student.abgeschlossen %}
                        <span class="badge badge-success">âœ… Fertig</span>
                    {% elif student.task_id %}
                        <span class="badge badge-primary">ğŸ”„ In Arbeit</span>
                    {% else %}
                        <span class="badge badge-warning">â³ Kein Thema</span>
                    {% endif %}
                </td>
                <td>
                    <a href="{{ url_for('admin_schueler_detail', student_id=student.id) }}" class="btn btn-sm btn-secondary">Bearbeiten</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p class="text-muted text-center">Noch keine SchÃ¼ler in dieser Klasse.</p>
    {% endif %}
</div>

<!-- Assign Sidequest (Freiwilliges Thema) to class -->
<div class="card mt-2">
    <div class="card-header">âœ¨ Freiwilliges Thema zuweisen</div>
    <form method="POST" action="{{ url_for('admin_klasse_sidequest_zuweisen', klasse_id=klasse.id) }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="flex gap-1 flex-center mb-1">
            <select name="task_id" class="form-control" style="flex: 1;" required>
                <option value="">-- Thema wÃ¤hlen --</option>
                {% for task in tasks %}
                <option value="{{ task.id }}">{{ task.fach }} ({{ task.stufe }}): {{ task.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div style="max-height: 180px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; padding: 0.5rem; margin-bottom: 0.5rem;">
            <label style="font-weight: bold; display: block; margin-bottom: 0.3rem;">
                <input type="checkbox" id="sq-alle"> Alle wÃ¤hlen
            </label>
            {% for student in students %}
            <label style="display: block;">
                <input type="checkbox" name="student_ids" value="{{ student.id }}" class="sq-student-cb"> {{ student.nachname }}, {{ student.vorname }}
            </label>
            {% endfor %}
        </div>
        <button type="submit" class="btn btn-secondary">Zuweisen</button>
    </form>
</div>

<!-- Active Sidequests Overview -->
{% if sidequests %}
<div class="card mt-2">
    <div class="card-header">âœ¨ Aktive Freiwillige Themen</div>
    <table class="table">
        <thead>
            <tr><th>SchÃ¼ler</th><th>Freiwilliges Thema</th></tr>
        </thead>
        <tbody>
            {% for sq in sidequests %}
            <tr>
                <td>{{ sq.vorname }} {{ sq.nachname }}</td>
                <td>{{ sq.task_name }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
document.getElementById('sq-alle').addEventListener('change', function() {
    document.querySelectorAll('.sq-student-cb').forEach(cb => cb.checked = this.checked);
});
{% endblock %}

