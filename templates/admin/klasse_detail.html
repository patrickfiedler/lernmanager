{% extends 'base.html' %}

{% block title %}{{ klasse.name }} - Lernmanager{% endblock %}

{% block content %}
<div class="flex flex-between flex-center mb-2">
    <h1>ğŸ“ {{ klasse.name }}</h1>
    <div class="flex gap-1">
        <a href="{{ url_for('admin_unterricht', klasse_id=klasse.id) }}" class="btn btn-primary">ğŸ“… Unterricht</a>
        <a href="{{ url_for('admin_klasse_bericht', klasse_id=klasse.id) }}" class="btn btn-success">ğŸ“Š Klassenbericht</a>
        <form method="POST" action="{{ url_for('admin_klasse_loeschen', klasse_id=klasse.id) }}" style="display: inline;" onsubmit="return confirm('Klasse wirklich lÃ¶schen?');">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button type="submit" class="btn btn-danger">ğŸ—‘ï¸ LÃ¶schen</button>
        </form>
    </div>
</div>

<!-- Batch Add Students -->
<div class="card mb-2">
    <div class="card-header">ğŸ‘¥ SchÃ¼ler hinzufÃ¼gen (Batch)</div>
    <form method="POST" action="{{ url_for('admin_klasse_schueler_hinzufuegen', klasse_id=klasse.id) }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="form-group">
            <label>Ein SchÃ¼ler pro Zeile: <code>Nachname, Vorname</code></label>
            <textarea name="batch_input" class="form-control" rows="5" placeholder="MÃ¼ller, Max&#10;Schmidt, Anna&#10;Weber, Tim"></textarea>
        </div>
        <button type="submit" class="btn btn-primary">HinzufÃ¼gen</button>
    </form>
</div>

<!-- Class Schedule -->
<div class="card mb-2">
    <div class="card-header">ğŸ“… WÃ¶chentlicher Unterricht</div>
    <form method="POST" action="{{ url_for('admin_klasse_schedule', klasse_id=klasse.id) }}" class="flex gap-1">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <select name="weekday" class="form-control" style="flex: 1;">
            <option value="">-- Kein regelmÃ¤ÃŸiger Termin --</option>
            <option value="0" {% if schedule and schedule.weekday == 0 %}selected{% endif %}>Montag</option>
            <option value="1" {% if schedule and schedule.weekday == 1 %}selected{% endif %}>Dienstag</option>
            <option value="2" {% if schedule and schedule.weekday == 2 %}selected{% endif %}>Mittwoch</option>
            <option value="3" {% if schedule and schedule.weekday == 3 %}selected{% endif %}>Donnerstag</option>
            <option value="4" {% if schedule and schedule.weekday == 4 %}selected{% endif %}>Freitag</option>
            <option value="5" {% if schedule and schedule.weekday == 5 %}selected{% endif %}>Samstag</option>
            <option value="6" {% if schedule and schedule.weekday == 6 %}selected{% endif %}>Sonntag</option>
        </select>
        <button type="submit" class="btn btn-primary">Speichern</button>
    </form>
    <small class="text-muted">Verwende Vor/ZurÃ¼ck-Buttons im Unterricht, um wÃ¶chentlich zu navigieren.</small>
</div>

<!-- Assign Task to Class -->
<div class="card mb-2">
    <div class="card-header">ğŸ“ Thema fÃ¼r alle zuweisen</div>
    <form method="POST" action="{{ url_for('admin_klasse_thema_zuweisen', klasse_id=klasse.id) }}" id="assign-task-form">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="flex gap-1 mb-1">
            <select name="task_id" id="task-select" class="form-control" style="flex: 1;" required onchange="loadSubtasks(this.value)">
                <option value="">-- Thema wÃ¤hlen --</option>
                {% for task in tasks %}
                <option value="{{ task.id }}">{{ task.fach }} ({{ task.stufe }}): {{ task.name }}</option>
                {% endfor %}
            </select>
            <button type="submit" class="btn btn-primary">Zuweisen</button>
        </div>
        <div id="subtask-selector" style="display: none;">
            <label class="text-muted">Aufgabe (optional):</label>
            <select name="subtask_id" id="subtask-select" class="form-control">
                <option value="">Alle Aufgaben zeigen</option>
            </select>
            <small class="text-muted">WÃ¤hle eine spezifische Aufgabe, um nur diese fÃ¼r alle SchÃ¼ler zu zeigen.</small>
        </div>
    </form>
</div>

<!-- Students List -->
<div class="card">
    <div class="card-header">ğŸ‘¥ SchÃ¼ler ({{ students|length }})</div>
    {% if students %}
    <table class="table">
        <thead>
            <tr>
                <th>Name</th>
                <th>Benutzername</th>
                <th>Aktuelles Thema</th>
                <th>Status</th>
                <th>Aktionen</th>
            </tr>
        </thead>
        <tbody>
            {% for student in students %}
            <tr>
                <td>
                    <a href="{{ url_for('admin_schueler_detail', student_id=student.id) }}">
                        <strong>{{ student.nachname }}, {{ student.vorname }}</strong>
                    </a>
                </td>
                <td><code>{{ student.username }}</code></td>
                <td>
                    {% if student.task_name %}
                        {{ student.task_name }}
                    {% else %}
                        <span class="text-muted">-</span>
                    {% endif %}
                </td>
                <td>
                    {% if student.abgeschlossen %}
                        <span class="badge badge-success">âœ… Fertig</span>
                    {% elif student.task_id %}
                        <span class="badge badge-primary">ğŸ”„ In Arbeit</span>
                    {% else %}
                        <span class="badge badge-warning">â³ Kein Thema</span>
                    {% endif %}
                </td>
                <td>
                    <a href="{{ url_for('admin_schueler_detail', student_id=student.id) }}" class="btn btn-sm btn-secondary">Bearbeiten</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p class="text-muted text-center">Noch keine SchÃ¼ler in dieser Klasse.</p>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
function loadSubtasks(taskId) {
    const subtaskSelector = document.getElementById('subtask-selector');
    const subtaskSelect = document.getElementById('subtask-select');

    if (!taskId) {
        subtaskSelector.style.display = 'none';
        return;
    }

    // Fetch subtasks for this task
    const csrfToken = document.querySelector('meta[name="csrf-token"]').content;
    fetch(`/admin/thema/${taskId}/aufgaben`, {
        headers: {
            'X-CSRFToken': csrfToken
        }
    })
    .then(r => r.json())
    .then(subtasks => {
        // Clear existing options
        subtaskSelect.innerHTML = '<option value="">Alle Aufgaben zeigen</option>';

        if (subtasks.length > 0) {
            subtasks.forEach((sub, index) => {
                const option = document.createElement('option');
                option.value = sub.id;
                option.textContent = `${index + 1}. ${sub.beschreibung.substring(0, 60)}${sub.beschreibung.length > 60 ? '...' : ''}`;
                subtaskSelect.appendChild(option);
            });
            subtaskSelector.style.display = 'block';
        } else {
            subtaskSelector.style.display = 'none';
        }
    })
    .catch(err => {
        console.error('Failed to load subtasks:', err);
        subtaskSelector.style.display = 'none';
    });
}
{% endblock %}
