{% extends 'base.html' %}

{% block title %}Unterricht {{ klasse.name }} - Lernmanager{% endblock %}

{% block content %}
<div class="flex flex-between flex-center mb-2">
    <h1>ğŸ“… Unterricht: {{ klasse.name }}</h1>
    <a href="{{ url_for('admin_klasse_detail', klasse_id=klasse.id) }}" class="btn btn-secondary">â† ZurÃ¼ck zur Klasse</a>
</div>

<div class="card mb-2">
    <div class="card-header">ğŸ“† Datum wÃ¤hlen</div>
    <div class="flex gap-1 flex-center">
        <a href="{{ url_for('admin_unterricht_prev', klasse_id=klasse.id, datum=datum) }}" class="btn btn-secondary" title="Vorherige Woche">â†</a>
        <form method="GET" action="{{ url_for('admin_unterricht_datum', klasse_id=klasse.id, datum=datum) }}" class="flex gap-1" id="date-form" style="flex: 1;">
            <input type="date" name="datum" class="form-control" style="width: 100%;" value="{{ datum }}" onchange="this.form.action = '{{ url_for('admin_unterricht_datum', klasse_id=klasse.id, datum='') }}' + this.value; this.form.submit();">
        </form>
        <a href="{{ url_for('admin_unterricht_next', klasse_id=klasse.id, datum=datum) }}" class="btn btn-secondary" title="NÃ¤chste Woche">â†’</a>
    </div>
</div>

{% if students %}
{# Calculate state based on has_been_saved #}
{% set saved_count = students|selectattr('has_been_saved', 'equalto', 1)|list|length %}
{% set total_count = students|length %}
{% if saved_count == 0 %}
    {% set table_state = 'no-data' %}
    {% set state_message = 'âš ï¸ Keine Daten fÃ¼r diesen Tag gespeichert. Standard-Werte (2) werden angezeigt.' %}
    {% set state_class = 'alert-danger-light' %}
{% elif saved_count < total_count %}
    {% set table_state = 'partial' %}
    {% set state_message = 'â³ Es gibt nicht gespeicherte Ã„nderungen. Daten werden automatisch gespeichert.' %}
    {% set state_class = 'alert-warning-light' %}
{% else %}
    {% set table_state = 'complete' %}
    {% set state_message = 'âœ“ Alle Daten fÃ¼r diesen Tag gespeichert.' %}
    {% set state_class = 'alert-success-light' %}
{% endif %}

<div class="card">
    <div class="card-header">ğŸ‘¥ SchÃ¼lerbewertung fÃ¼r {{ datum }}</div>
    <div class="{{ state_class }}">{{ state_message }}</div>
    <table class="table unterricht-table unterricht-{{ table_state }}">
        <thead>
            <tr>
                <th>Name</th>
                <th style="width: 80px;">Anwesend</th>
                <th style="width: 120px;">SelbststÃ¤ndigkeit</th>
                <th style="width: 120px;">Respekt</th>
                <th style="width: 120px;">Fortschritt</th>
                <th>Kommentar</th>
            </tr>
        </thead>
        <tbody>
            {% for student in students %}
            <tr data-student-id="{{ student.student_id }}">
                <td><strong>{{ student.nachname }}, {{ student.vorname }}</strong></td>
                <td>
                    <label class="attendance-toggle" data-student-id="{{ student.student_id }}">
                        <input type="checkbox" {% if student.anwesend %}checked{% endif %} onchange="toggleAttendance(this, {{ student.student_id }})">
                        <span class="attendance-label">
                            <span class="attendance-icon">âœ“</span>
                            Anwesend
                        </span>
                    </label>
                </td>
                <td>
                    <div class="rating-group">
                        {% for i in [1, 2, 3] %}
                        <button type="button" class="rating-btn {% if student.admin_selbststaendigkeit == i %}active-{{ i }}{% if not student.has_been_saved %} unsaved{% endif %}{% endif %}"
                                onclick="setRating(this, {{ student.student_id }}, 'admin_selbststaendigkeit', {{ i }})">{{ i }}</button>
                        {% endfor %}
                    </div>
                </td>
                <td>
                    <div class="rating-group">
                        {% for i in [1, 2, 3] %}
                        <button type="button" class="rating-btn {% if student.admin_respekt == i %}active-{{ i }}{% if not student.has_been_saved %} unsaved{% endif %}{% endif %}"
                                onclick="setRating(this, {{ student.student_id }}, 'admin_respekt', {{ i }})">{{ i }}</button>
                        {% endfor %}
                    </div>
                </td>
                <td>
                    <div class="rating-group">
                        {% for i in [1, 2, 3] %}
                        <button type="button" class="rating-btn {% if student.admin_fortschritt == i %}active-{{ i }}{% if not student.has_been_saved %} unsaved{% endif %}{% endif %}"
                                onclick="setRating(this, {{ student.student_id }}, 'admin_fortschritt', {{ i }})">{{ i }}</button>
                        {% endfor %}
                    </div>
                </td>
                <td>
                    <input type="text" class="form-control" value="{{ student.admin_kommentar or '' }}"
                           onchange="updateComment(this, {{ student.student_id }})"
                           placeholder="Kommentar...">
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <div class="flex gap-1 flex-between flex-center" style="padding: 1rem; background: var(--gray-50); border-top: 1px solid var(--gray-200);">
        <span id="unsaved-count" style="display: none; color: var(--warning); font-weight: bold;"></span>
        <button id="save-btn" class="btn btn-primary" onclick="saveAll()" disabled>ğŸ’¾ Speichern</button>
    </div>
</div>

<div class="card mt-2">
    <div class="card-header">ğŸ“Š Legende</div>
    <div class="flex gap-2">
        <div><span class="rating-btn active-1" style="pointer-events: none;">1</span> = Verbesserungsbedarf</div>
        <div><span class="rating-btn active-2" style="pointer-events: none;">2</span> = Gut (Standard)</div>
        <div><span class="rating-btn active-3" style="pointer-events: none;">3</span> = Sehr gut</div>
    </div>
</div>
{% else %}
<div class="card text-center text-muted">
    <p>Keine SchÃ¼ler in dieser Klasse.</p>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
const unterrichtId = {{ unterricht_id }};
const unsavedChanges = new Set();

function updateUnsavedCount() {
    const count = unsavedChanges.size;
    const saveBtn = document.getElementById('save-btn');
    const countDisplay = document.getElementById('unsaved-count');

    if (count > 0) {
        saveBtn.disabled = false;
        saveBtn.classList.add('btn-warning');
        saveBtn.classList.remove('btn-primary');
        countDisplay.textContent = `${count} Ã„nderung${count > 1 ? 'en' : ''} nicht gespeichert`;
        countDisplay.style.display = 'inline';
    } else {
        saveBtn.disabled = true;
        saveBtn.classList.remove('btn-warning');
        saveBtn.classList.add('btn-primary');
        countDisplay.style.display = 'none';
    }
}

function markAsChanged(studentId) {
    unsavedChanges.add(studentId);
    const row = document.querySelector(`tr[data-student-id="${studentId}"]`);
    row.classList.add('unsaved-row');
    updateUnsavedCount();
}

function saveStudent(studentId) {
    const row = document.querySelector(`tr[data-student-id="${studentId}"]`);
    const csrfToken = document.querySelector('meta[name="csrf-token"]').content;
    const data = new FormData();
    data.append('student_id', studentId);
    data.append('anwesend', row.querySelector('.attendance-toggle input[type="checkbox"]').checked ? '1' : '');

    // Get ratings
    ['admin_selbststaendigkeit', 'admin_respekt', 'admin_fortschritt'].forEach(field => {
        const active = row.querySelector(`.rating-group button[onclick*="${field}"].active-1, .rating-group button[onclick*="${field}"].active-2, .rating-group button[onclick*="${field}"].active-3`);
        if (active) {
            const val = active.textContent;
            data.append(field, val);
        }
    });

    data.append('admin_kommentar', row.querySelector('input[type="text"]').value);

    return fetch(`/admin/unterricht/${unterrichtId}/bewertung`, {
        method: 'POST',
        headers: {'X-CSRFToken': csrfToken},
        body: data
    }).then(() => {
        unsavedChanges.delete(studentId);
        row.classList.remove('unsaved-row');
        updateUnsavedCount();
    });
}

async function saveAll() {
    const saveBtn = document.getElementById('save-btn');
    const originalText = saveBtn.innerHTML;
    saveBtn.innerHTML = 'ğŸ’¾ Speichern...';
    saveBtn.disabled = true;

    const studentIds = Array.from(unsavedChanges);
    const promises = studentIds.map(id => saveStudent(id));

    try {
        await Promise.all(promises);
        saveBtn.innerHTML = 'âœ… Gespeichert!';
        setTimeout(() => {
            saveBtn.innerHTML = originalText;
            updateUnsavedCount();
        }, 2000);
    } catch (error) {
        alert('Fehler beim Speichern. Bitte erneut versuchen.');
        saveBtn.innerHTML = originalText;
        saveBtn.disabled = false;
    }
}

function updateAttendanceUI(row, isPresent) {
    const ratingButtons = row.querySelectorAll('.rating-btn');
    const commentInput = row.querySelector('input[type="text"]');

    ratingButtons.forEach(btn => {
        btn.disabled = !isPresent;
        if (!isPresent) {
            btn.classList.add('disabled');
        } else {
            btn.classList.remove('disabled');
        }
    });

    commentInput.disabled = !isPresent;

    // Clear ratings if marking absent
    if (!isPresent) {
        ratingButtons.forEach(btn => {
            btn.classList.remove('active-1', 'active-2', 'active-3', 'unsaved');
        });
        commentInput.value = '';
    }
}

function toggleAttendance(checkbox, studentId) {
    const row = document.querySelector(`tr[data-student-id="${studentId}"]`);
    const isPresent = checkbox.checked;

    // Update UI based on attendance
    updateAttendanceUI(row, isPresent);

    // Mark as changed for manual save
    markAsChanged(studentId);
}

// Initialize attendance UI on page load
document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('tr[data-student-id]').forEach(row => {
        const checkbox = row.querySelector('.attendance-toggle input[type="checkbox"]');
        if (checkbox) {
            updateAttendanceUI(row, checkbox.checked);
        }
    });
});

// Warn before leaving page with unsaved changes
window.addEventListener('beforeunload', (event) => {
    if (unsavedChanges.size > 0) {
        event.preventDefault();
        event.returnValue = ''; // Chrome requires returnValue to be set
        return 'Sie haben nicht gespeicherte Ã„nderungen. MÃ¶chten Sie die Seite wirklich verlassen?';
    }
});

function setRating(btn, studentId, field, value) {
    const group = btn.parentElement;
    group.querySelectorAll('.rating-btn').forEach(b => {
        b.classList.remove('active-1', 'active-2', 'active-3');
    });
    btn.classList.add(`active-${value}`);
    markAsChanged(studentId);
}

function updateComment(input, studentId) {
    markAsChanged(studentId);
}
{% endblock %}
