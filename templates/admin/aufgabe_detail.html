{% extends 'base.html' %}

{% block title %}{{ task.name }} - Lernmanager{% endblock %}

{% block content %}
<div class="flex flex-between flex-center mb-2">
    <h1>ğŸ“ {{ task.name }}</h1>
    <div class="flex gap-1">
        {% if task.kategorie == 'bonus' %}
        <span class="badge badge-warning">â­ Bonus</span>
        {% else %}
        <span class="badge badge-primary">Pflicht</span>
        {% endif %}
        <form method="POST" action="{{ url_for('admin_aufgabe_loeschen', task_id=task.id) }}" onsubmit="return confirm('Aufgabe wirklich lÃ¶schen?');">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button type="submit" class="btn btn-danger">ğŸ—‘ï¸ LÃ¶schen</button>
        </form>
    </div>
</div>

<!-- Basic Info -->
<div class="card">
    <div class="card-header">â„¹ï¸ Grunddaten</div>
    <form method="POST" action="{{ url_for('admin_aufgabe_bearbeiten', task_id=task.id) }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="grid grid-2">
            <div class="form-group">
                <label>Name</label>
                <input type="text" name="name" class="form-control" value="{{ task.name }}" required>
            </div>
            <div class="form-group">
                <label>Nummer (fÃ¼r Sortierung)</label>
                <input type="number" name="number" class="form-control" value="{{ task.number }}" min="0" required>
            </div>
            <div class="form-group">
                <label>Kategorie</label>
                <select name="kategorie" class="form-control" required>
                    <option value="pflicht" {% if task.kategorie == 'pflicht' %}selected{% endif %}>Pflicht</option>
                    <option value="bonus" {% if task.kategorie == 'bonus' %}selected{% endif %}>â­ Bonus</option>
                </select>
            </div>
            <div class="form-group">
                <label>Fach</label>
                <select name="fach" class="form-control" required>
                    {% for s in subjects %}<option value="{{ s }}" {% if task.fach == s %}selected{% endif %}>{{ s }}</option>{% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label>Stufe</label>
                <select name="stufe" class="form-control" required>
                    {% for l in levels %}<option value="{{ l }}" {% if task.stufe == l %}selected{% endif %}>{{ l }}</option>{% endfor %}
                </select>
            </div>
        </div>
        <div class="form-group">
            <label>Lernziel <small class="text-muted">(Markdown)</small></label>
            <div class="markdown-editor">
                <textarea name="lernziel" id="lernziel" class="form-control" rows="3" oninput="updatePreview('lernziel', 'preview-lernziel')">{{ task.lernziel or '' }}</textarea>
                <div class="markdown-preview markdown-content" id="preview-lernziel"></div>
            </div>
        </div>
        <div class="form-group">
            <label>Beschreibung <small class="text-muted">(Markdown)</small></label>
            <div class="markdown-editor">
                <textarea name="beschreibung" id="beschreibung" class="form-control" rows="4" oninput="updatePreview('beschreibung', 'preview-beschreibung')">{{ task.beschreibung or '' }}</textarea>
                <div class="markdown-preview markdown-content" id="preview-beschreibung"></div>
            </div>
        </div>
        <div class="form-group">
            <label>Voraussetzungen</label>
            <select name="voraussetzungen" class="form-control" multiple size="4">
                {% for t in all_tasks %}
                {% if t.id != task.id %}
                <option value="{{ t.id }}" {% if t.id in voraussetzungen|map(attribute='id')|list %}selected{% endif %}>{{ t.fach }} ({{ t.stufe }}): {{ t.name }}</option>
                {% endif %}
                {% endfor %}
            </select>
            <small class="text-muted">Strg/Cmd fÃ¼r Mehrfachauswahl</small>
        </div>
        <input type="hidden" name="quiz_json" value="{{ task.quiz_json or '' }}">
        <button type="submit" class="btn btn-primary">Speichern</button>
    </form>
</div>

<!-- Subtasks -->
<div class="card mt-2">
    <div class="card-header">âœ… Teilaufgaben <small class="text-muted">(Markdown)</small></div>
    <form method="POST" action="{{ url_for('admin_aufgabe_teilaufgaben', task_id=task.id) }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div id="subtask-list">
            {% for st in subtasks %}
            <div class="subtask-edit-item" data-index="{{ loop.index0 }}">
                <div class="subtask-edit-header">
                    <span class="subtask-edit-number">{{ loop.index }}</span>
                    <button type="button" class="btn btn-danger btn-sm" onclick="removeSubtask(this)">âœ• Entfernen</button>
                </div>
                <div class="markdown-editor">
                    <textarea name="subtasks[]" class="form-control subtask-textarea" rows="6" placeholder="Teilaufgabe..." oninput="updateSubtaskPreview(this)">{{ st.beschreibung }}</textarea>
                    <div class="markdown-preview markdown-content"></div>
                </div>
            </div>
            {% endfor %}
        </div>
        <div class="flex gap-1 mt-1">
            <button type="button" class="btn btn-secondary" onclick="addSubtask()">+ Teilaufgabe</button>
            <button type="submit" class="btn btn-primary">Speichern</button>
        </div>
    </form>
</div>

<!-- Materials -->
<div class="card mt-2">
    <div class="card-header">ğŸ“ Materialien</div>

    {% if materials %}
    <ul class="material-list mb-2">
        {% for mat in materials %}
        <li class="material-item flex flex-between">
            <div>
                {% if mat.typ == 'link' %}
                <span class="material-icon">ğŸ”—</span>
                <a href="{{ mat.pfad }}" target="_blank">{{ mat.beschreibung or mat.pfad }}</a>
                {% else %}
                <span class="material-icon">ğŸ“„</span>
                <a href="{{ url_for('download_material', material_id=mat.id) }}" target="_blank">{{ mat.beschreibung or mat.pfad }}</a>
                {% endif %}
            </div>
            <form method="POST" action="{{ url_for('admin_material_loeschen', material_id=mat.id) }}" style="display: inline;">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button type="submit" class="btn btn-sm btn-danger">ğŸ—‘ï¸</button>
            </form>
        </li>
        {% endfor %}
    </ul>
    {% endif %}

    <div class="grid grid-2">
        <div>
            <h4 class="mb-1">ğŸ”— Link hinzufÃ¼gen</h4>
            <form method="POST" action="{{ url_for('admin_aufgabe_material_link', task_id=task.id) }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="form-group">
                    <input type="url" name="url" class="form-control" placeholder="https://..." required>
                </div>
                <div class="form-group">
                    <input type="text" name="beschreibung" class="form-control" placeholder="Beschreibung (optional)">
                </div>
                <button type="submit" class="btn btn-secondary">Link hinzufÃ¼gen</button>
            </form>
        </div>
        <div>
            <h4 class="mb-1">ğŸ“¤ Datei hochladen</h4>
            <form method="POST" action="{{ url_for('admin_aufgabe_material_upload', task_id=task.id) }}" enctype="multipart/form-data">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="form-group">
                    <input type="file" name="file" class="form-control" accept=".pdf,.png,.jpg,.jpeg,.gif" required>
                </div>
                <div class="form-group">
                    <input type="text" name="beschreibung" class="form-control" placeholder="Beschreibung (optional)">
                </div>
                <button type="submit" class="btn btn-secondary">Hochladen</button>
            </form>
        </div>
    </div>
</div>

<!-- Quiz -->
<div class="card mt-2">
    <div class="card-header">â“ Quiz</div>
    <form method="POST" action="{{ url_for('admin_aufgabe_bearbeiten', task_id=task.id) }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="hidden" name="name" value="{{ task.name }}">
        <input type="hidden" name="fach" value="{{ task.fach }}">
        <input type="hidden" name="stufe" value="{{ task.stufe }}">
        <input type="hidden" name="kategorie" value="{{ task.kategorie }}">
        <input type="hidden" name="lernziel" value="{{ task.lernziel or '' }}">
        <input type="hidden" name="beschreibung" value="{{ task.beschreibung or '' }}">
        {% for v in voraussetzungen %}
        <input type="hidden" name="voraussetzungen" value="{{ v.id }}">
        {% endfor %}

        <div class="form-group">
            <label>Quiz JSON (fÃ¼r LLM-Generierung geeignet):</label>
            <textarea name="quiz_json" class="form-control" rows="10" placeholder='{
  "questions": [
    {
      "question": "Was ist die Hauptstadt von Deutschland?",
      "answers": ["Berlin", "MÃ¼nchen", "Hamburg", "KÃ¶ln"],
      "correct": [0]
    },
    {
      "question": "Welche Farben hat die deutsche Flagge?",
      "answers": ["Rot und WeiÃŸ", "Blau und Gelb", "Schwarz, Rot und Gold", "GrÃ¼n und WeiÃŸ"],
      "correct": [2]
    }
  ]
}'>{{ task.quiz_json or '' }}</textarea>
            <small class="text-muted">Format: JSON mit "questions" Array. Jede Frage hat "question", "answers" (4 Optionen) und "correct" (Array mit Indizes der richtigen Antworten).</small>
        </div>
        <button type="submit" class="btn btn-primary">Quiz speichern</button>
    </form>
</div>
{% endblock %}

{% block scripts %}
// Markdown preview for main fields
function updatePreview(textareaId, previewId) {
    const text = document.getElementById(textareaId).value;
    document.getElementById(previewId).innerHTML = marked.parse(text || '');
}

// Markdown preview for subtasks
function updateSubtaskPreview(textarea) {
    const preview = textarea.closest('.markdown-editor').querySelector('.markdown-preview');
    preview.innerHTML = marked.parse(textarea.value || '');
}

// Initialize all previews on page load
document.addEventListener('DOMContentLoaded', function() {
    updatePreview('lernziel', 'preview-lernziel');
    updatePreview('beschreibung', 'preview-beschreibung');
    // Initialize subtask previews
    document.querySelectorAll('.subtask-textarea').forEach(textarea => {
        updateSubtaskPreview(textarea);
    });
    renumberSubtasks();
});

// Subtask management
function addSubtask() {
    const list = document.getElementById('subtask-list');
    const count = list.querySelectorAll('.subtask-edit-item').length;
    const item = document.createElement('div');
    item.className = 'subtask-edit-item';
    item.innerHTML = `
        <div class="subtask-edit-header">
            <span class="subtask-edit-number">${count + 1}</span>
            <button type="button" class="btn btn-danger btn-sm" onclick="removeSubtask(this)">âœ• Entfernen</button>
        </div>
        <div class="markdown-editor">
            <textarea name="subtasks[]" class="form-control subtask-textarea" rows="6" placeholder="Teilaufgabe..." oninput="updateSubtaskPreview(this)"></textarea>
            <div class="markdown-preview markdown-content"></div>
        </div>
    `;
    list.appendChild(item);
    item.querySelector('textarea').focus();
}

function removeSubtask(btn) {
    btn.closest('.subtask-edit-item').remove();
    renumberSubtasks();
}

function renumberSubtasks() {
    document.querySelectorAll('.subtask-edit-item').forEach((item, index) => {
        item.querySelector('.subtask-edit-number').textContent = index + 1;
    });
}
{% endblock %}
