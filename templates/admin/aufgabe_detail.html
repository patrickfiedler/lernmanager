{% extends 'base.html' %}

{% block title %}{{ task.name }} - Lernmanager{% endblock %}

{% block content %}
<div class="flex flex-between flex-center mb-2">
    <h1>ğŸ“ {{ task.name }}</h1>
    <div class="flex gap-1">
        {% if task.kategorie == 'bonus' %}
        <span class="badge badge-warning">â­ Bonus</span>
        {% else %}
        <span class="badge badge-primary">Pflicht</span>
        {% endif %}
        <a href="{{ url_for('admin_thema_export', task_id=task.id) }}" class="btn btn-secondary">ğŸ“¥ Export</a>
        <form method="POST" action="{{ url_for('admin_thema_loeschen', task_id=task.id) }}" onsubmit="return confirm('Thema wirklich lÃ¶schen?');">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button type="submit" class="btn btn-danger">ğŸ—‘ï¸ LÃ¶schen</button>
        </form>
    </div>
</div>

<!-- Basic Info -->
<div class="card">
    <div class="card-header">â„¹ï¸ Grunddaten</div>
    <form method="POST" action="{{ url_for('admin_thema_bearbeiten', task_id=task.id) }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="grid grid-2">
            <div class="form-group">
                <label>Name</label>
                <input type="text" name="name" class="form-control" value="{{ task.name }}" required>
            </div>
            <div class="form-group">
                <label>Nummer (fÃ¼r Sortierung)</label>
                <input type="number" name="number" class="form-control" value="{{ task.number }}" min="0" required>
            </div>
            <div class="form-group">
                <label>Kategorie</label>
                <select name="kategorie" class="form-control" required>
                    <option value="pflicht" {% if task.kategorie == 'pflicht' %}selected{% endif %}>Pflicht</option>
                    <option value="bonus" {% if task.kategorie == 'bonus' %}selected{% endif %}>â­ Bonus</option>
                </select>
            </div>
            <div class="form-group">
                <label>Fach</label>
                <select name="fach" class="form-control" required>
                    {% for s in subjects %}<option value="{{ s }}" {% if task.fach == s %}selected{% endif %}>{{ s }}</option>{% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label>Stufe</label>
                <select name="stufe" class="form-control" required>
                    {% for l in levels %}<option value="{{ l }}" {% if task.stufe == l %}selected{% endif %}>{{ l }}</option>{% endfor %}
                </select>
            </div>
        </div>
        <div class="form-group">
            <label>Lernziel (Lehrkraft) <small class="text-muted">(Markdown) â€” â€Die SuS kÃ¶nnenâ€¦"</small></label>
            <div class="markdown-editor">
                <textarea name="lernziel" id="lernziel" class="form-control" rows="3" oninput="updatePreview('lernziel', 'preview-lernziel')">{{ task.lernziel or '' }}</textarea>
                <div class="markdown-preview markdown-content" id="preview-lernziel"></div>
            </div>
        </div>
        <div class="form-group">
            <label>Lernziel (SchÃ¼ler) <small class="text-muted">(Markdown, optional) â€” â€Du lernstâ€¦"</small></label>
            <div class="markdown-editor">
                <textarea name="lernziel_schueler" id="lernziel_schueler" class="form-control" rows="3" oninput="updatePreview('lernziel_schueler', 'preview-lernziel-schueler')">{{ task.lernziel_schueler or '' }}</textarea>
                <div class="markdown-preview markdown-content" id="preview-lernziel-schueler"></div>
            </div>
            <small class="text-muted">Wenn leer, sehen SchÃ¼ler das Lehrkraft-Lernziel.</small>
        </div>
        <div class="form-group">
            <label>Beschreibung <small class="text-muted">(Markdown)</small></label>
            <div class="markdown-editor">
                <textarea name="beschreibung" id="beschreibung" class="form-control" rows="4" oninput="updatePreview('beschreibung', 'preview-beschreibung')">{{ task.beschreibung or '' }}</textarea>
                <div class="markdown-preview markdown-content" id="preview-beschreibung"></div>
            </div>
        </div>
        <div class="form-group">
            <label>WofÃ¼r brauchen die SchÃ¼ler das? ğŸ’¡</label>
            <textarea name="why_learn_this" class="form-control" rows="2" placeholder="z.B. 'Du lernst, wie Computer funktionieren - das brauchst du, um digitale GerÃ¤te zu verstehen.'">{{ task.why_learn_this or '' }}</textarea>
            <small class="text-muted">Kurze ErklÃ¤rung (1-2 SÃ¤tze), altersgerecht fÃ¼r Stufe {{ task.stufe }}. Wird den SchÃ¼lern prominent angezeigt. {% if not task.why_learn_this %}<strong style="color: #ca8a04;">âš ï¸ Noch nicht ausgefÃ¼llt</strong>{% endif %}</small>
        </div>
        <div class="form-group">
            <label>
                <input type="checkbox" name="subtask_quiz_required" value="1" {% if task.subtask_quiz_required %}checked{% endif %}>
                Aufgaben-Quiz muss bestanden werden (ca. 70%) bevor nÃ¤chste Aufgabe freigeschaltet wird
            </label>
        </div>
        <input type="hidden" name="quiz_json" value="{{ task.quiz_json or '' }}">
        <button type="submit" class="btn btn-primary">Speichern</button>
    </form>
</div>

<!-- Subtasks -->
<div class="card mt-2">
    <div class="card-header">âœ… Aufgaben <small class="text-muted">(Markdown)</small></div>
    <form method="POST" action="{{ url_for('admin_thema_aufgaben', task_id=task.id) }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div id="subtask-list">
            {% for st in subtasks %}
            <div class="subtask-edit-item" data-index="{{ loop.index0 }}">
                <div class="subtask-edit-header">
                    <span class="subtask-edit-number">{{ loop.index }}</span>
                    <div class="flex gap-1 flex-center">
                        <select name="path[]" class="form-control" style="width: 140px;" title="Lernpfad">
                            <option value="">â€“ Pfad â€“</option>
                            <option value="wanderweg" {% if st.path == 'wanderweg' %}selected{% endif %}>ğŸŸ¢ Wanderweg</option>
                            <option value="bergweg" {% if st.path == 'bergweg' %}selected{% endif %}>ğŸ”µ Bergweg</option>
                            <option value="gipfeltour" {% if st.path == 'gipfeltour' %}selected{% endif %}>â­ Gipfeltour</option>
                        </select>
                        <select name="path_model[]" class="form-control" style="width: 100px;" title="Pfadmodell">
                            <option value="skip" {% if st.path_model != 'depth' %}selected{% endif %}>Skip</option>
                            <option value="depth" {% if st.path_model == 'depth' %}selected{% endif %}>Depth</option>
                        </select>
                        <input type="number" name="estimated_minutes[]" class="form-control" style="width: 80px;" min="5" max="180" placeholder="Min" value="{{ st.estimated_minutes or '' }}" title="GeschÃ¤tzte Dauer in Minuten">
                        <button type="button" class="btn btn-danger btn-sm" onclick="removeSubtask(this)">âœ• Entfernen</button>
                    </div>
                </div>
                <div class="markdown-editor">
                    <textarea name="subtasks[]" class="form-control subtask-textarea" rows="6" placeholder="Aufgabe..." oninput="updateSubtaskPreview(this)">{{ st.beschreibung }}</textarea>
                    <div class="markdown-preview markdown-content"></div>
                </div>
                <div class="form-group mt-1">
                    <label style="font-size: 0.875rem; color: #374151;">âœ… Fertig wenn: <small class="text-muted">(optional â€” wird als grÃ¼ner Kasten Ã¼ber dem HÃ¤kchen angezeigt)</small></label>
                    <textarea name="fertig_wenn[]" class="form-control" rows="2" placeholder="z.B. Du hast alle Schritte erledigt und dein Ergebnis gespeichert.">{{ st.fertig_wenn or '' }}</textarea>
                </div>
                <details class="subtask-quiz-toggle">
                    <summary>â“ Aufgaben-Quiz {% if st.quiz_json %}<span class="badge badge-primary">Quiz vorhanden</span>{% endif %}</summary>
                    <textarea name="quiz_json[]" class="form-control mt-1" rows="4" placeholder='{"questions": [{"text": "Frage?", "options": ["A", "B", "C", "D"], "correct": [0]}]}'>{{ st.quiz_json or '' }}</textarea>
                    <small class="text-muted">JSON-Format wie beim Themen-Quiz. Leer lassen = kein Quiz fÃ¼r diese Aufgabe.</small>
                </details>
            </div>
            {% endfor %}
        </div>
        <div class="flex gap-1 mt-1">
            <button type="button" class="btn btn-secondary" onclick="addSubtask()">+ Aufgabe</button>
            <button type="submit" class="btn btn-primary">Speichern</button>
        </div>
    </form>
</div>

<!-- Materials -->
<div class="card mt-2">
    <div class="card-header">ğŸ“ Materialien</div>

    {% if materials %}
    <ul class="material-list mb-2">
        {% for mat in materials %}
        <li class="material-item flex flex-between">
            <div>
                {% if mat.typ == 'link' %}
                <span class="material-icon">ğŸ”—</span>
                <a href="{{ mat.pfad }}" target="_blank">{{ mat.beschreibung or mat.pfad }}</a>
                {% else %}
                <span class="material-icon">ğŸ“„</span>
                <a href="{{ url_for('download_material', material_id=mat.id) }}" target="_blank">{{ mat.beschreibung or mat.pfad }}</a>
                {% endif %}
            </div>
            <form method="POST" action="{{ url_for('admin_material_loeschen', material_id=mat.id) }}" style="display: inline;">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button type="submit" class="btn btn-sm btn-danger">ğŸ—‘ï¸</button>
            </form>
        </li>
        {% endfor %}
    </ul>
    {% endif %}

    {% if materials and subtasks %}
    <!-- Material-Aufgabe Assignment Table -->
    <form method="POST" action="{{ url_for('admin_material_zuordnung', task_id=task.id) }}" class="mb-2">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <h4 class="mb-1">ğŸ“‹ Zuordnung zu Aufgaben</h4>
        <small class="text-muted mb-1" style="display: block;">Welche Materialien sollen bei welchen Aufgaben angezeigt werden? Keine Auswahl = Ã¼berall sichtbar.</small>
        <div style="overflow-x: auto;">
            <table class="table" style="min-width: auto;">
                <thead>
                    <tr>
                        <th>Material</th>
                        {% for st in subtasks %}
                        <th style="text-align: center; min-width: 40px;" title="{{ st.beschreibung[:60] }}">{{ loop.index }}</th>
                        {% endfor %}
                        <th style="text-align: center; min-width: 50px;">Alle</th>
                    </tr>
                </thead>
                <tbody>
                    {% for mat in materials %}
                    {% set assigned = material_assignments.get(mat.id, []) %}
                    {% set is_all = (assigned | length) == 0 %}
                    <tr>
                        <td>
                            {% if mat.typ == 'link' %}ğŸ”—{% else %}ğŸ“„{% endif %}
                            {{ mat.beschreibung or mat.pfad }}
                        </td>
                        {% for st in subtasks %}
                        <td style="text-align: center;">
                            <input type="checkbox" name="mat_{{ mat.id }}[]" value="{{ st.id }}"
                                   data-mat-id="{{ mat.id }}"
                                   onchange="handleAssignmentChange({{ mat.id }})"
                                   {% if is_all or st.id in assigned %}checked{% endif %}>
                        </td>
                        {% endfor %}
                        <td style="text-align: center;">
                            <input type="checkbox" name="mat_{{ mat.id }}_alle"
                                   data-mat-alle="{{ mat.id }}"
                                   onchange="toggleAllForMaterial({{ mat.id }})"
                                   {% if is_all %}checked{% endif %}>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <button type="submit" class="btn btn-primary">Zuordnung speichern</button>
    </form>
    {% endif %}

    <div class="grid grid-2">
        <div>
            <h4 class="mb-1">ğŸ”— Link hinzufÃ¼gen</h4>
            <form method="POST" action="{{ url_for('admin_thema_material_link', task_id=task.id) }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="form-group">
                    <input type="url" name="url" class="form-control" placeholder="https://..." required>
                </div>
                <div class="form-group">
                    <input type="text" name="beschreibung" class="form-control" placeholder="Beschreibung (optional)">
                </div>
                <button type="submit" class="btn btn-secondary">Link hinzufÃ¼gen</button>
            </form>
        </div>
        <div>
            <h4 class="mb-1">ğŸ“¤ Datei hochladen</h4>
            <form method="POST" action="{{ url_for('admin_thema_material_upload', task_id=task.id) }}" enctype="multipart/form-data">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="form-group">
                    <input type="file" name="file" class="form-control" accept=".pdf,.png,.jpg,.jpeg,.gif" required>
                </div>
                <div class="form-group">
                    <input type="text" name="beschreibung" class="form-control" placeholder="Beschreibung (optional)">
                </div>
                <button type="submit" class="btn btn-secondary">Hochladen</button>
            </form>
        </div>
    </div>
</div>

<!-- Quiz -->
<div class="card mt-2">
    <div class="card-header">â“ Quiz</div>
    <form method="POST" action="{{ url_for('admin_thema_bearbeiten', task_id=task.id) }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="hidden" name="name" value="{{ task.name }}">
        <input type="hidden" name="fach" value="{{ task.fach }}">
        <input type="hidden" name="stufe" value="{{ task.stufe }}">
        <input type="hidden" name="kategorie" value="{{ task.kategorie }}">
        <input type="hidden" name="lernziel" value="{{ task.lernziel or '' }}">
        <input type="hidden" name="lernziel_schueler" value="{{ task.lernziel_schueler or '' }}">
        <input type="hidden" name="beschreibung" value="{{ task.beschreibung or '' }}">

        <div class="form-group">
            <label>Quiz JSON (fÃ¼r LLM-Generierung geeignet):</label>
            <textarea name="quiz_json" class="form-control" rows="10" placeholder='{
  "questions": [
    {
      "question": "Was ist die Hauptstadt von Deutschland?",
      "answers": ["Berlin", "MÃ¼nchen", "Hamburg", "KÃ¶ln"],
      "correct": [0]
    },
    {
      "question": "Welche Farben hat die deutsche Flagge?",
      "answers": ["Rot und WeiÃŸ", "Blau und Gelb", "Schwarz, Rot und Gold", "GrÃ¼n und WeiÃŸ"],
      "correct": [2]
    }
  ]
}'>{{ task.quiz_json or '' }}</textarea>
            <small class="text-muted">Format: JSON mit "questions" Array. Jede Frage hat "question", "answers" (4 Optionen) und "correct" (Array mit Indizes der richtigen Antworten).</small>
        </div>
        <button type="submit" class="btn btn-primary">Quiz speichern</button>
    </form>
</div>
{% endblock %}

{% block scripts %}
// Unsaved changes tracking
let initialBasicInfoState = '';
let initialSubtasksState = '';
let initialQuizState = '';

function captureFormState(form) {
    if (!form) return '';
    const formData = new FormData(form);
    const entries = Array.from(formData.entries()).sort((a, b) => {
        const keyA = a[0];
        const keyB = b[0];
        if (keyA < keyB) return -1;
        if (keyA > keyB) return 1;
        return 0;
    });
    return JSON.stringify(entries);
}

function getBasicInfoForm() {
    // First form with bearbeiten (edit) action - in Basic Info card
    return document.querySelector('.card form[action*="/bearbeiten"]');
}

function getSubtasksForm() {
    // Form with teilaufgaben (subtasks) action
    return document.querySelector('form[action*="/aufgaben"]');
}

function getQuizForm() {
    // Quiz form is inside a card with "Quiz" in the header, find it by the quiz_json textarea
    const quizTextarea = document.querySelector('textarea[name="quiz_json"]');
    return quizTextarea ? quizTextarea.closest('form') : null;
}

function hasUnsavedChanges() {
    const currentBasicInfo = captureFormState(getBasicInfoForm());
    const currentSubtasks = captureFormState(getSubtasksForm());
    const currentQuiz = captureFormState(getQuizForm());

    return (currentBasicInfo !== initialBasicInfoState) ||
           (currentSubtasks !== initialSubtasksState) ||
           (currentQuiz !== initialQuizState);
}

// Markdown preview for main fields
function updatePreview(textareaId, previewId) {
    const text = document.getElementById(textareaId).value;
    document.getElementById(previewId).innerHTML = marked.parse(text || '');
}

// Markdown preview for subtasks
function updateSubtaskPreview(textarea) {
    const preview = textarea.closest('.markdown-editor').querySelector('.markdown-preview');
    preview.innerHTML = marked.parse(textarea.value || '');
}

// Initialize all previews on page load
document.addEventListener('DOMContentLoaded', function() {
    updatePreview('lernziel', 'preview-lernziel');
    updatePreview('lernziel_schueler', 'preview-lernziel-schueler');
    updatePreview('beschreibung', 'preview-beschreibung');
    // Initialize subtask previews
    document.querySelectorAll('.subtask-textarea').forEach(textarea => {
        updateSubtaskPreview(textarea);
    });
    renumberSubtasks();

    // Capture initial form states
    setTimeout(() => {
        initialBasicInfoState = captureFormState(getBasicInfoForm());
        initialSubtasksState = captureFormState(getSubtasksForm());
        initialQuizState = captureFormState(getQuizForm());
    }, 100);

    // Add warning to material forms
    const materialForms = document.querySelectorAll('form[action*="material-link"], form[action*="material-upload"]');
    materialForms.forEach(form => {
        form.addEventListener('submit', function(e) {
            if (hasUnsavedChanges()) {
                if (!confirm('âš ï¸ Du hast ungespeicherte Ã„nderungen in den Grunddaten, Aufgaben oder im Quiz.\n\nWenn du jetzt Material hinzufÃ¼gst, gehen diese Ã„nderungen verloren.\n\nMÃ¶chtest du trotzdem fortfahren?')) {
                    e.preventDefault();
                }
            }
        });
    });

    // Warn before leaving page with unsaved changes
    window.addEventListener('beforeunload', function(e) {
        if (hasUnsavedChanges()) {
            e.preventDefault();
            e.returnValue = '';
        }
    });

    // Update initial state after successful save
    const basicInfoForm = getBasicInfoForm();
    const subtasksForm = getSubtasksForm();
    const quizForm = getQuizForm();

    if (basicInfoForm) {
        basicInfoForm.addEventListener('submit', function() {
            initialBasicInfoState = captureFormState(getBasicInfoForm());
        });
    }

    if (subtasksForm) {
        subtasksForm.addEventListener('submit', function() {
            initialSubtasksState = captureFormState(getSubtasksForm());
        });
    }

    if (quizForm) {
        quizForm.addEventListener('submit', function() {
            initialQuizState = captureFormState(getQuizForm());
        });
    }
});

// Material-Aufgabe assignment helpers
function toggleAllForMaterial(matId) {
    const alleCheckbox = document.querySelector(`[data-mat-alle="${matId}"]`);
    const checkboxes = document.querySelectorAll(`[data-mat-id="${matId}"]`);
    checkboxes.forEach(cb => cb.checked = alleCheckbox.checked);
}

function handleAssignmentChange(matId) {
    const checkboxes = document.querySelectorAll(`[data-mat-id="${matId}"]`);
    const alleCheckbox = document.querySelector(`[data-mat-alle="${matId}"]`);
    const allChecked = Array.from(checkboxes).every(cb => cb.checked);
    alleCheckbox.checked = allChecked;
}

// Subtask management
function addSubtask() {
    const list = document.getElementById('subtask-list');
    const count = list.querySelectorAll('.subtask-edit-item').length;
    const item = document.createElement('div');
    item.className = 'subtask-edit-item';
    item.innerHTML = `
        <div class="subtask-edit-header">
            <span class="subtask-edit-number">${count + 1}</span>
            <div class="flex gap-1 flex-center">
                <select name="path[]" class="form-control" style="width: 140px;" title="Lernpfad">
                    <option value="">â€“ Pfad â€“</option>
                    <option value="wanderweg">ğŸŸ¢ Wanderweg</option>
                    <option value="bergweg" selected>ğŸ”µ Bergweg</option>
                    <option value="gipfeltour">â­ Gipfeltour</option>
                </select>
                <select name="path_model[]" class="form-control" style="width: 100px;" title="Pfadmodell">
                    <option value="skip" selected>Skip</option>
                    <option value="depth">Depth</option>
                </select>
                <input type="number" name="estimated_minutes[]" class="form-control" style="width: 80px;" min="5" max="180" placeholder="Min" title="GeschÃ¤tzte Dauer in Minuten">
                <button type="button" class="btn btn-danger btn-sm" onclick="removeSubtask(this)">âœ• Entfernen</button>
            </div>
        </div>
        <div class="markdown-editor">
            <textarea name="subtasks[]" class="form-control subtask-textarea" rows="6" placeholder="Aufgabe..." oninput="updateSubtaskPreview(this)"></textarea>
            <div class="markdown-preview markdown-content"></div>
        </div>
        <div class="form-group mt-1">
            <label style="font-size: 0.875rem; color: #374151;">âœ… Fertig wenn: <small class="text-muted">(optional â€” wird als grÃ¼ner Kasten Ã¼ber dem HÃ¤kchen angezeigt)</small></label>
            <textarea name="fertig_wenn[]" class="form-control" rows="2" placeholder="z.B. Du hast alle Schritte erledigt und dein Ergebnis gespeichert."></textarea>
        </div>
        <details class="subtask-quiz-toggle">
            <summary>â“ Aufgaben-Quiz</summary>
            <textarea name="quiz_json[]" class="form-control mt-1" rows="4" placeholder='{"questions": [{"text": "Frage?", "options": ["A", "B", "C", "D"], "correct": [0]}]}'></textarea>
            <small class="text-muted">JSON-Format wie beim Themen-Quiz. Leer lassen = kein Quiz fÃ¼r diese Aufgabe.</small>
        </details>
    `;
    list.appendChild(item);
    item.querySelector('textarea').focus();
}

function removeSubtask(btn) {
    btn.closest('.subtask-edit-item').remove();
    renumberSubtasks();
}

function renumberSubtasks() {
    document.querySelectorAll('.subtask-edit-item').forEach((item, index) => {
        item.querySelector('.subtask-edit-number').textContent = index + 1;
    });
}
{% endblock %}
