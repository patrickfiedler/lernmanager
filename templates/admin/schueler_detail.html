{% extends 'base.html' %}

{% block title %}{{ student.vorname }} {{ student.nachname }} - Lernmanager{% endblock %}

{% block content %}
<div class="flex flex-between flex-center mb-2">
    <h1>ğŸ‘¤ {{ student.nachname }}, {{ student.vorname }}</h1>
    <div class="flex gap-1">
        <a href="{{ url_for('admin_student_activity', student_id=student.id) }}" class="btn btn-secondary">ğŸ“Š AktivitÃ¤t</a>
        <div class="btn-group">
            <a href="{{ url_for('admin_schueler_bericht', student_id=student.id, type='summary') }}" class="btn btn-success">ğŸ“„ Bericht (Zusammenfassung)</a>
            <a href="{{ url_for('admin_schueler_bericht', student_id=student.id, type='complete') }}" class="btn btn-success">ğŸ“‹ Bericht (VollstÃ¤ndig)</a>
        </div>
        <form method="POST" action="{{ url_for('admin_schueler_loeschen', student_id=student.id) }}" onsubmit="return confirm('SchÃ¼ler wirklich lÃ¶schen?');" style="display: inline;">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button type="submit" class="btn btn-danger">ğŸ—‘ï¸ LÃ¶schen</button>
        </form>
    </div>
</div>

<div class="grid grid-2">
    <!-- Login Info -->
    <div class="card">
        <div class="card-header">ğŸ”‘ Anmeldedaten</div>
        <p><strong>Benutzername:</strong> <code>{{ student.username }}</code></p>
        <p class="text-muted" style="font-size: 0.9em;">Passwort nur bei Erstellung oder Reset sichtbar</p>
        <form method="POST" action="{{ url_for('admin_schueler_passwort_reset', student_id=student.id) }}"
              onsubmit="return confirm('Passwort wirklich zurÃ¼cksetzen? Das alte Passwort wird ungÃ¼ltig.');" class="mt-1">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button type="submit" class="btn btn-warning">ğŸ”„ Passwort zurÃ¼cksetzen</button>
        </form>
    </div>

    <!-- Classes -->
    <div class="card">
        <div class="card-header">ğŸ“ Klassen</div>
        {% if klassen %}
        <ul class="material-list">
            {% for klasse in klassen %}
            <li class="material-item">
                <a href="{{ url_for('admin_klasse_detail', klasse_id=klasse.id) }}">{{ klasse.name }}</a>
            </li>
            {% endfor %}
        </ul>
        {% else %}
        <p class="text-muted">Keine Klassen zugewiesen.</p>
        {% endif %}
    </div>
</div>

<!-- Move Student -->
{% if klassen %}
<div class="card mt-2">
    <div class="card-header">ğŸ”„ SchÃ¼ler verschieben</div>
    <form method="POST" action="{{ url_for('admin_schueler_verschieben', student_id=student.id) }}" class="flex gap-1 flex-center">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <label>Von:</label>
        <select name="from_klasse" class="form-control" style="width: auto;" required>
            {% for klasse in klassen %}
            <option value="{{ klasse.id }}">{{ klasse.name }}</option>
            {% endfor %}
        </select>
        <label>Nach:</label>
        <select name="to_klasse" class="form-control" style="width: auto;" required>
            {% for klasse in all_klassen %}
            <option value="{{ klasse.id }}">{{ klasse.name }}</option>
            {% endfor %}
        </select>
        <button type="submit" class="btn btn-primary">Verschieben</button>
    </form>
</div>
{% endif %}

<!-- Assign Individual Task -->
{% if klassen %}
<div class="card mt-2">
    <div class="card-header">ğŸ“ Individuelle Aufgabe zuweisen</div>
    <form method="POST" action="{{ url_for('admin_schueler_aufgabe_zuweisen', student_id=student.id) }}" id="assign-student-task-form">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="flex gap-1 flex-center mb-1">
            <label>Klasse:</label>
            <select name="klasse_id" class="form-control" style="width: auto;" required>
                {% for klasse in klassen %}
                <option value="{{ klasse.id }}">{{ klasse.name }}</option>
                {% endfor %}
            </select>
            <label>Aufgabe:</label>
            <select name="task_id" id="student-task-select" class="form-control" style="flex: 1;" required onchange="loadSubtasksForStudent(this.value)">
                <option value="">-- Aufgabe wÃ¤hlen --</option>
                {% for task in tasks %}
                <option value="{{ task.id }}">{{ task.fach }} ({{ task.stufe }}): {{ task.name }}</option>
                {% endfor %}
            </select>
            <button type="submit" class="btn btn-primary">Zuweisen</button>
        </div>
        <div id="student-subtask-selector" style="display: none;">
            <label class="text-muted">Teilaufgabe (optional):</label>
            <select name="subtask_id" id="student-subtask-select" class="form-control">
                <option value="">Alle Teilaufgaben zeigen</option>
            </select>
            <small class="text-muted">WÃ¤hle eine spezifische Teilaufgabe, um nur diese fÃ¼r den SchÃ¼ler zu zeigen.</small>
        </div>
    </form>
</div>

<!-- Manage Current Subtask -->
<div class="card mt-2">
    <div class="card-header">ğŸ¯ Aktuelle Teilaufgabe verwalten</div>
    {% for klasse in klassen %}
    {% set task = student_tasks.get(klasse.id) %}
    {% if task and task.subtasks %}
    <div class="mb-2" style="padding: 1rem; background: #f9fafb; border-radius: 0.375rem;">
        <div class="flex flex-between flex-center mb-1">
            <strong>{{ klasse.name }}: {{ task.name }}</strong>
            {% if task.current_subtask %}
            <span class="badge badge-primary">Filter aktiv</span>
            {% else %}
            <span class="badge badge-secondary">Alle sichtbar</span>
            {% endif %}
        </div>
        <form method="POST" action="{{ url_for('admin_schueler_teilaufgabe_setzen', student_id=student.id) }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="klasse_id" value="{{ klasse.id }}">
            <div class="flex gap-1">
                <select name="subtask_id" class="form-control" style="flex: 1;">
                    <option value="">Alle Teilaufgaben zeigen</option>
                    {% for sub in task.subtasks %}
                    <option value="{{ sub.id }}" {% if task.current_subtask and task.current_subtask.id == sub.id %}selected{% endif %}>
                        {{ loop.index }}. {{ sub.beschreibung[:60] }}{% if sub.beschreibung|length > 60 %}...{% endif %}
                        {% if sub.erledigt %}âœ“{% endif %}
                    </option>
                    {% endfor %}
                </select>
                <button type="submit" class="btn btn-secondary">Aktualisieren</button>
            </div>
            {% if task.current_subtask %}
            <small class="text-muted">Aktuell: Teilaufgabe {{ loop.index }} sichtbar</small>
            {% else %}
            <small class="text-muted">Alle {{ task.subtasks|length }} Teilaufgaben sichtbar</small>
            {% endif %}
        </form>
    </div>
    {% endif %}
    {% endfor %}
    {% set has_tasks_with_subtasks = namespace(value=false) %}
    {% for klasse in klassen %}
        {% set task = student_tasks.get(klasse.id) %}
        {% if task and task.subtasks %}
            {% set has_tasks_with_subtasks.value = true %}
        {% endif %}
    {% endfor %}
    {% if not klassen or not has_tasks_with_subtasks.value %}
    <p class="text-muted">Keine aktiven Aufgaben mit Teilaufgaben.</p>
    {% endif %}
</div>

<!-- Manual Task Completion -->
<div class="card mt-2">
    <div class="card-header">âœ… Aufgabe manuell abschlieÃŸen</div>
    <div class="flex gap-1">
        {% for klasse in klassen %}
        <form method="POST" action="{{ url_for('admin_schueler_aufgabe_abschliessen', student_id=student.id, klasse_id=klasse.id) }}" style="display: inline;">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button type="submit" class="btn btn-success">{{ klasse.name }} abschlieÃŸen</button>
        </form>
        {% endfor %}
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
function loadSubtasksForStudent(taskId) {
    const subtaskSelector = document.getElementById('student-subtask-selector');
    const subtaskSelect = document.getElementById('student-subtask-select');

    if (!taskId) {
        subtaskSelector.style.display = 'none';
        return;
    }

    // Fetch subtasks for this task
    const csrfToken = document.querySelector('meta[name="csrf-token"]').content;
    fetch(`/admin/aufgabe/${taskId}/teilaufgaben`, {
        headers: {
            'X-CSRFToken': csrfToken
        }
    })
    .then(r => r.json())
    .then(subtasks => {
        // Clear existing options
        subtaskSelect.innerHTML = '<option value="">Alle Teilaufgaben zeigen</option>';

        if (subtasks.length > 0) {
            subtasks.forEach((sub, index) => {
                const option = document.createElement('option');
                option.value = sub.id;
                option.textContent = `${index + 1}. ${sub.beschreibung.substring(0, 60)}${sub.beschreibung.length > 60 ? '...' : ''}`;
                subtaskSelect.appendChild(option);
            });
            subtaskSelector.style.display = 'block';
        } else {
            subtaskSelector.style.display = 'none';
        }
    })
    .catch(err => {
        console.error('Failed to load subtasks:', err);
        subtaskSelector.style.display = 'none';
    });
}
{% endblock %}
