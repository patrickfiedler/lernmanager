{% extends 'base.html' %}

{% block title %}Themen importieren - Lernmanager{% endblock %}

{% block content %}
<div class="flex flex-between flex-center mb-2">
    <h1>üì§ Themen importieren</h1>
    <a href="{{ url_for('admin_themen') }}" class="btn btn-secondary">Zur√ºck</a>
</div>

{% if not preview %}
{# === Upload Form === #}
<div class="card">
    <p class="mb-1">JSON-Datei hochladen (Einzelexport oder Sammelexport).</p>
    <form method="POST" enctype="multipart/form-data">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="hidden" name="action" value="preview">
        <div class="form-group">
            <label for="json_file">JSON-Datei</label>
            <input type="file" id="json_file" name="json_file" accept=".json" required class="form-control">
        </div>
        <button type="submit" class="btn btn-primary mt-1">Vorschau</button>
    </form>
</div>

{% else %}
{# === Preview === #}

{% if errors %}
<div class="alert alert-danger">
    <strong>Validierungsfehler:</strong>
    <ul class="mt-1" style="margin-bottom: 0;">
        {% for error in errors %}
        <li>{{ error }}</li>
        {% endfor %}
    </ul>
</div>
<div class="card mt-1">
    <a href="{{ url_for('admin_themen_import') }}" class="btn btn-secondary">Neue Datei w√§hlen</a>
</div>
{% else %}

{% if warnings %}
<div class="alert alert-warning">
    <strong>Hinweise:</strong>
    <ul class="mt-1" style="margin-bottom: 0;">
        {% for warning in warnings %}
        <li>{{ warning }}</li>
        {% endfor %}
    </ul>
</div>
{% endif %}

<form method="POST" id="import-form">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <input type="hidden" name="action" value="confirm">
    <textarea name="json_data" style="display:none;">{{ json_data }}</textarea>

    {% for topic in topics_preview %}
    <div class="card mb-1">
        <h3>{{ topic.name }}</h3>
        <table class="table mt-1">
            <tbody>
                <tr><td style="width:12rem"><strong>Fach</strong></td><td>{{ topic.fach }}</td></tr>
                <tr><td><strong>Stufe</strong></td><td>{{ topic.stufe }}</td></tr>
                <tr><td><strong>Kategorie</strong></td><td>{{ topic.kategorie }}</td></tr>
                {% if topic.number %}
                <tr><td><strong>Nummer</strong></td><td>{{ topic.number }}</td></tr>
                {% endif %}
                <tr>
                    <td><strong>Aufgaben</strong></td>
                    <td>
                        {{ topic.subtask_count }} gesamt
                        {% if topic.path_counts %}
                        (üü¢ {{ topic.path_counts.wanderweg }}
                        / üîµ {{ topic.path_counts.bergweg }}
                        / ‚≠ê {{ topic.path_counts.gipfeltour }})
                        {% endif %}
                    </td>
                </tr>
                <tr><td><strong>Materialien</strong></td><td>{{ topic.material_count }}</td></tr>
                {% if topic.topic_quiz_count %}
                <tr><td><strong>Themen-Quiz</strong></td><td>{{ topic.topic_quiz_count }} Fragen</td></tr>
                {% endif %}
                {% if topic.subtask_quiz_count %}
                <tr><td><strong>Aufgaben-Quizze</strong></td><td>{{ topic.subtask_quiz_count }} Aufgaben mit Quiz</td></tr>
                {% endif %}
            </tbody>
        </table>

        {# Action selector: new import or overwrite existing #}
        <div class="mt-1" style="padding-top: 0.75rem; border-top: 1px solid var(--border-color, #ddd);">
            <label for="action_{{ loop.index0 }}" style="font-weight: 600;">Aktion:</label>
            <select name="action_{{ loop.index0 }}" id="action_{{ loop.index0 }}" class="form-control import-action-select" data-index="{{ loop.index0 }}" style="max-width: 30rem; display: inline-block; margin-left: 0.5rem;">
                <option value="new">Neu importieren</option>
                <optgroup label="Vorhandenes Thema √ºberschreiben">
                    {% for et in existing_tasks %}
                    <option value="{{ et.id }}" {% if topic.existing_task_id == et.id %}selected{% endif %}>
                        {{ et.fach }} {{ et.stufe }}: {{ et.name }}
                    </option>
                    {% endfor %}
                </optgroup>
            </select>

            <div class="reset-option mt-1" id="reset_{{ loop.index0 }}" style="display: none;">
                <label style="cursor: pointer;">
                    <input type="checkbox" name="reset_{{ loop.index0 }}" value="1">
                    Fortschritte zur√ºcksetzen
                </label>
                <div style="font-size: 0.85rem; color: var(--text-muted, #666); margin-top: 0.25rem;">
                    Setzt alle Sch√ºler-Fortschritte zur√ºck. Zuweisungen bleiben erhalten.
                </div>
            </div>
        </div>
    </div>
    {% endfor %}

    <div class="flex gap-1 mt-1">
        <button type="submit" class="btn btn-primary" id="import-submit-btn">Importieren</button>
        <a href="{{ url_for('admin_themen_import') }}" class="btn btn-secondary">Abbrechen</a>
    </div>
</form>

{% endif %}
{% endif %}
{% endblock %}

{% block scripts %}
// Import page: toggle reset checkbox and update button text
(function() {
    var selects = document.querySelectorAll('.import-action-select');
    if (!selects.length) return;

    function updateUI() {
        var newCount = 0, overwriteCount = 0;
        selects.forEach(function(sel) {
            var idx = sel.dataset.index;
            var resetDiv = document.getElementById('reset_' + idx);
            if (sel.value === 'new') {
                newCount++;
                if (resetDiv) resetDiv.style.display = 'none';
            } else {
                overwriteCount++;
                if (resetDiv) resetDiv.style.display = 'block';
            }
        });

        var btn = document.getElementById('import-submit-btn');
        if (!btn) return;
        var parts = [];
        if (newCount > 0) parts.push(newCount + ' importieren');
        if (overwriteCount > 0) parts.push(overwriteCount + ' √ºberschreiben');
        btn.textContent = parts.join(' + ');
    }

    selects.forEach(function(sel) {
        sel.addEventListener('change', updateUI);
    });
    updateUI();
})();
{% endblock %}
