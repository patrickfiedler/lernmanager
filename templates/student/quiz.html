{% extends 'base.html' %}

{% block title %}{% if position %}Aufgaben-Quiz{% else %}Quiz{% endif %}: {{ task.name }} - Lernmanager{% endblock %}

{% block content %}
<div class="flex flex-between flex-center mb-2">
    <h1>‚ùì {% if position %}Aufgaben-Quiz{% else %}Quiz: {{ task.name }}{% endif %}</h1>
    <a href="{{ url_for('student_klasse', slug=slug) }}" class="btn btn-secondary">‚Üê Abbrechen</a>
</div>

<div class="card mb-2">
    {% if not position %}
    <p><strong>üéØ Lernziel:</strong> {{ task.lernziel_schueler or task.lernziel or 'Nicht angegeben' }}</p>
    {% endif %}
    {% set total = quiz.questions|length %}
    {% set min_richtig = [1, (total * 0.7)|int]|max %}
    <p class="text-muted">Du brauchst mindestens {{ min_richtig }} von {{ total }} richtigen Antworten, um das Quiz zu bestehen.</p>
</div>

<form method="POST" action="{% if position %}{{ url_for('student_quiz_subtask', slug=slug, position=position) }}{% else %}{{ url_for('student_quiz', slug=slug) }}{% endif %}">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <!-- Hidden fields for question/answer order mapping -->
    <input type="hidden" name="question_order" value="{{ question_order }}">
    {% for answer_map in answer_maps %}
    <input type="hidden" name="answer_map_{{ loop.index0 }}" value="{{ answer_map }}">
    {% endfor %}

    {% for question in quiz.questions %}
    <div class="quiz-question">
        <h4>Frage {{ loop.index }}: {{ question.question }}</h4>
        {% if question.image %}
        <img src="{{ question.image }}" alt="Bild zur Frage {{ loop.index }}" class="quiz-question-image">
        {% endif %}

        {% if question.type == 'fill_blank' %}
        <input type="text" name="q{{ loop.index0 }}" class="form-control" placeholder="Antwort eingeben..." autocomplete="off">
        {% elif question.type == 'short_answer' %}
        <textarea name="q{{ loop.index0 }}" class="form-control" rows="3" placeholder="Antwort in eigenen Worten..."></textarea>
        {% else %}
        {# Multiple choice (default) #}
        {% for answer in question.answers %}
        <label class="quiz-option">
            <input type="checkbox" name="q{{ loop.index0 - 1 }}" value="{{ loop.index0 }}"
                   {% if question.correct|length == 1 %}onclick="uncheckOthers(this)"{% endif %}>
            {% if answer is mapping %}
            <span>{{ answer.text }}</span>
            {% if answer.image %}<img src="{{ answer.image }}" alt="{{ answer.text }}" class="quiz-option-image">{% endif %}
            {% else %}
            <span>{{ answer }}</span>
            {% endif %}
        </label>
        {% endfor %}
        {% if question.correct|length > 1 %}
        <p class="text-muted mt-1">üí° Mehrere Antworten k√∂nnen richtig sein.</p>
        {% endif %}
        {% endif %}
    </div>
    {% endfor %}

    <button type="submit" class="btn btn-primary btn-lg">Quiz abschicken</button>
</form>
{% endblock %}

{% block scripts %}
// Fix checkbox name indexing (only for multiple-choice questions)
document.querySelectorAll('.quiz-question').forEach((q, idx) => {
    q.querySelectorAll('input[type="checkbox"]').forEach(input => {
        input.name = 'q' + idx;
    });
});

function uncheckOthers(checkbox) {
    if (checkbox.checked) {
        const name = checkbox.name;
        document.querySelectorAll(`input[name="${name}"]`).forEach(cb => {
            if (cb !== checkbox) cb.checked = false;
        });
    }
}
{% endblock %}
