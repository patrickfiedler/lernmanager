{% extends 'base.html' %}

{% block title %}{% if task %}{{ task.name }} - {% endif %}Lernmanager{% endblock %}

{% block content %}
{% if task %}
<!-- Main Content Card (contains everything) -->
<div class="content-card">

    <!-- Topic Headline -->
    <h1 class="topic-headline">{{ task.name }}</h1>
    <!-- Purpose Banner (Why learn this?) -->
    {% if task.why_learn_this %}
    <div class="purpose">
        <div class="purpose-icon">ğŸ’¡</div>
        <div>
            <div class="purpose-label">WofÃ¼r brauchst du das?</div>
            {{ task.why_learn_this }}
        </div>
    </div>
    {% endif %}

    <!-- Progress Section with Dots -->
    {% if subtasks %}
    <div class="progress-section">
        <div class="progress-header">
            <div class="progress-text" id="progress-text">
                {% set required_subtasks = subtasks|selectattr('required')|list if student_path else subtasks %}
                {{ required_subtasks|selectattr('erledigt')|list|length }} von {{ required_subtasks|length }} Aufgaben erledigt
            </div>
            <div class="progress-dots" role="group" aria-label="Aufgabenfortschritt">
                {% for sub in subtasks %}
                {% set has_quiz = sub.quiz_json %}
                {% set quiz_passed = subtask_quiz_status.get(sub.id, false) %}
                <div class="dot dot-subtask {% if sub.erledigt %}completed {% endif %}{% if current_subtask and sub.id == current_subtask.id %}current{% endif %}{% if not sub.get('required', true) %} optional{% endif %}"
                     role="button"
                     tabindex="0"
                     aria-label="Aufgabe {{ loop.index }}: {{ sub.beschreibung[:50] }}{% if sub.beschreibung|length > 50 %}...{% endif %}{% if sub.erledigt %} - Erledigt{% endif %}{% if not sub.get('required', true) %} (optional){% endif %}"
                     {% if current_subtask and sub.id == current_subtask.id %}aria-current="true"{% endif %}
                     data-subtask-position="{{ loop.index }}"
                     data-required="{{ 'true' if sub.get('required', true) else 'false' }}"
                     onclick="navigateToSubtask({{ loop.index }})"
                     onkeydown="handleDotKeydown(event)"
                     title="{% if sub.get('path') %}{% if sub.path == 'wanderweg' %}ğŸŸ¢{% elif sub.path == 'bergweg' %}ğŸ”µ{% elif sub.path == 'gipfeltour' %}â­{% endif %} {% endif %}Aufgabe {{ loop.index }}{% if not sub.get('required', true) %} (optional){% endif %}"></div>
                {% if has_quiz %}
                <div class="dot dot-subtask-quiz {% if quiz_passed %}completed{% elif sub.erledigt %}available{% endif %}"
                     role="button"
                     tabindex="0"
                     aria-label="Quiz zu Aufgabe {{ loop.index }}{% if quiz_passed %} - Bestanden{% elif sub.erledigt %} - VerfÃ¼gbar{% else %} - Gesperrt{% endif %}"
                     data-quiz-position="{{ loop.index }}"
                     data-quiz-passed="{{ 'true' if quiz_passed else 'false' }}"
                     data-quiz-available="{{ 'true' if sub.erledigt else 'false' }}"
                     onclick="navigateToSubtaskQuiz({{ loop.index }}, {{ 'true' if quiz_passed else 'false' }}, {{ 'true' if sub.erledigt else 'false' }})"
                     onkeydown="handleDotKeydown(event)"
                     title="Quiz zu Aufgabe {{ loop.index }}{% if quiz_passed %} (bestanden){% elif sub.erledigt %} (verfÃ¼gbar){% endif %}">?</div>
                {% endif %}
                {% endfor %}
                {% if task.quiz_json %}
                <div class="dot dot-quiz {% if quiz_bestanden %}completed{% endif %}"
                     role="button"
                     tabindex="0"
                     aria-label="Abschlussquiz{% if quiz_bestanden %} - Bestanden{% endif %}"
                     title="Abschlussquiz"
                     data-is-quiz="true"
                     onclick="navigateToQuiz({{ 'true' if quiz_bestanden else 'false' }})"
                     onkeydown="handleDotKeydown(event)">?</div>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Current Task/Subtask with Side Navigation -->
    {% if current_subtask or subtasks %}
    {% set active_subtask = current_subtask or (subtasks|rejectattr('erledigt')|list|first) %}
    {% set current_index = subtasks.index(active_subtask) if active_subtask and active_subtask in subtasks else 0 %}
    {% set has_prev = current_index > 0 %}
    {% set has_next = current_index < (subtasks|length - 1) or (current_index == (subtasks|length - 1) and task.quiz_json) %}

    <div class="task-navigation-wrapper">
        <!-- Desktop: Left Button -->
        <button class="nav-button-side nav-prev {% if not has_prev %}nav-disabled{% endif %}"
                onclick="goToPrevSubtask({{ current_index }})"
                {% if not has_prev %}disabled{% endif %}>
            <span class="nav-arrow">â†</span>
            <span class="nav-label">ZurÃ¼ck</span>
        </button>

        <!-- Content (shows first on mobile, center on desktop) -->
        <div class="current-task">
            {% if active_subtask %}
            <div class="task-badge-group">
                <div class="task-badge">Aufgabe {{ current_index + 1 }} von {{ subtasks|length }}</div>
                {% if active_subtask.estimated_minutes %}
                <div class="task-badge time-estimate">â±ï¸ ~{{ active_subtask.estimated_minutes }} Min</div>
                {% endif %}
                {% if not active_subtask.get('required', true) %}
                <div class="task-badge" style="background: #fef3c7; color: #92400e;">Optional fÃ¼r deinen Weg</div>
                {% endif %}
            </div>
            {% endif %}

            <div class="task-content markdown-content">
                {% if active_subtask %}
                {{ active_subtask.beschreibung | markdown }}
                {% endif %}
            </div>

            <!-- Checkbox to mark complete -->
            {% if active_subtask and not task.abgeschlossen %}
            <div class="task-complete" onclick="document.getElementById('subtask-checkbox-{{ active_subtask.id }}').click()">
                <input type="checkbox"
                       id="subtask-checkbox-{{ active_subtask.id }}"
                       class="subtask-checkbox"
                       {% if active_subtask.erledigt %}checked{% endif %}
                       onchange="toggleSubtask({{ current_index + 1 }}, this.checked)"
                       onclick="event.stopPropagation()">
                <label for="subtask-checkbox-{{ active_subtask.id }}">Ich habe das geschafft! âœ“</label>
            </div>
            {% endif %}

            <!-- Subtask Quiz Card (shown when subtask done but quiz pending) -->
            {% if active_subtask and active_subtask.erledigt and active_subtask.quiz_json and not subtask_quiz_status.get(active_subtask.id, false) and task.subtask_quiz_required %}
            <div class="quiz-card mt-1">
                <div class="quiz-header">â“ Aufgaben-Quiz</div>
                <p>Beantworte die Fragen, bevor du zur nÃ¤chsten Aufgabe weitergehst.</p>
                <a href="{{ url_for('student_quiz_subtask', slug=task.name|slugify, position=current_index + 1) }}" class="btn btn-primary">Quiz starten</a>
            </div>
            {% endif %}

            <!-- Success Banner (hidden initially, shown after completing task) -->
            <div class="success-banner" id="success-banner" style="display: none;">
                <span class="success-icon">âœ“</span>
                <div>Gut gemacht! Aufgabe erledigt.</div>
            </div>
        </div>

        <!-- Desktop: Right Button -->
        <button class="nav-button-side nav-next {% if not has_next %}nav-disabled{% endif %}"
                onclick="goToNextSubtask({{ current_index }})"
                {% if not has_next %}disabled{% endif %}>
            <span class="nav-arrow">â†’</span>
            <span class="nav-label">Weiter</span>
        </button>

        <!-- Mobile: Button wrapper (appears after content) -->
        <div class="nav-buttons-mobile">
            <button class="nav-button-side nav-prev {% if not has_prev %}nav-disabled{% endif %}"
                    onclick="goToPrevSubtask({{ current_index }})"
                    {% if not has_prev %}disabled{% endif %}>
                <span class="nav-arrow">â†</span>
                <span class="nav-label">ZurÃ¼ck</span>
            </button>
            <button class="nav-button-side nav-next {% if not has_next %}nav-disabled{% endif %}"
                    onclick="goToNextSubtask({{ current_index }})"
                    {% if not has_next %}disabled{% endif %}>
                <span class="nav-arrow">â†’</span>
                <span class="nav-label">Weiter</span>
            </button>
        </div>
    </div>


    <!-- Completed Subtasks (collapsible) -->
    {% if completed_subtasks %}
    <details class="completed-tasks-toggle mt-2">
        <summary>âœ“ {{ completed_subtasks|length }} Aufgabe(n) bereits erledigt</summary>
        <div class="completed-tasks-content">
            {% for sub in completed_subtasks %}
            <div class="completed-task-item">
                <span class="check-icon">âœ“</span>
                <div class="completed-task-text">{{ sub.beschreibung[:100] }}{% if sub.beschreibung|length > 100 %}...{% endif %}</div>
            </div>
            {% endfor %}
        </div>
    </details>
    {% endif %}

    {% else %}
    <!-- Q3B: Encouraging Empty State -->
    <div class="empty-state-card">
        <div class="empty-state-icon">âœ¨</div>
        <h2 class="empty-state-title">Weitere Themen kommen bald!</h2>
        <p class="empty-state-text">Dein Lehrer bereitet sie vor.</p>
    </div>
    {% endif %}

    <!-- Materials Section (collapsible, default open) -->
    {% if materials %}
    <details class="materials-toggle mt-2" open>
        <summary>ğŸ“ Materialien</summary>
        <div class="materials-content">
            <ul class="material-list">
                {% for mat in materials %}
                <li class="material-item">
                    {% if mat.typ == 'link' %}
                    <span class="material-icon">ğŸ”—</span>
                    <a href="{{ mat.pfad }}" target="_blank">{{ mat.beschreibung or mat.pfad }}</a>
                    {% else %}
                    <span class="material-icon">ğŸ“„</span>
                    <a href="{{ url_for('download_material', material_id=mat.id) }}" target="_blank">{{ mat.beschreibung or mat.pfad }}</a>
                    {% endif %}
                </li>
                {% endfor %}
            </ul>
        </div>
    </details>
    {% endif %}

    <!-- Quiz Section (if all subtasks complete) -->
    {% if task.quiz_json %}
    {% set all_complete = (all_subtasks|selectattr('erledigt')|list|length == all_subtasks|length) %}
    {% if all_complete and not task.abgeschlossen %}
    <div class="quiz-card mt-2">
        <div class="quiz-header">â“ Quiz</div>
        {% if quiz_attempts %}
        <div class="quiz-attempts">
            <p><strong>Bisherige Versuche:</strong></p>
            {% for attempt in quiz_attempts[:3] %}
            <div class="quiz-attempt">
                {{ attempt.timestamp[:10] }}: {{ attempt.punkte }}/{{ attempt.max_punkte }} Punkte
                {% if attempt.bestanden %}
                <span class="badge badge-success">âœ… Bestanden</span>
                {% else %}
                <span class="badge badge-danger">âŒ Nicht bestanden</span>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        {% endif %}
        <a href="{{ url_for('student_quiz', slug=task.name|slugify) }}" class="btn btn-primary mt-1">Quiz starten</a>
    </div>
    {% elif task.abgeschlossen %}
    <div class="alert alert-success mt-2">
        âœ… Quiz bestanden! Thema abgeschlossen.
    </div>
    {% endif %}
    {% endif %}

    <!-- Next topic from queue -->
    {% if task.abgeschlossen and next_topic %}
    <div class="card mt-2" style="border-left: 4px solid #22c55e;">
        <div class="card-header">ğŸ¯ NÃ¤chstes Thema: {{ next_topic.name }}</div>
        <p class="text-muted mb-1">{{ next_topic.fach }} ({{ next_topic.stufe }})</p>
        <form method="POST" action="{{ url_for('student_start_next_topic') }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="task_id" value="{{ next_topic.task_id }}">
            <input type="hidden" name="klasse_id" value="{{ klasse.id }}">
            <button type="submit" class="btn btn-success">NÃ¤chstes Thema starten â†’</button>
        </form>
    </div>
    {% endif %}

    <!-- Topic Description (expandable, at bottom) -->
    <details class="topic-description-toggle mt-2">
        <summary>AusfÃ¼hrliche Beschreibung</summary>
        <div class="topic-description-content">
            {% set lz = task.lernziel_schueler or task.lernziel %}
            {% if lz %}
            <div class="mb-1">
                <strong>ğŸ¯ Lernziel:</strong>
                <div class="markdown-content">{{ lz | markdown }}</div>
            </div>
            {% endif %}
            {% if task.beschreibung %}
            <div>
                <strong>ğŸ“‹ Beschreibung:</strong>
                <div class="markdown-content">{{ task.beschreibung | markdown }}</div>
            </div>
            {% endif %}
            {% if not lz and not task.beschreibung %}
            <p class="text-muted">Keine zusÃ¤tzlichen Informationen verfÃ¼gbar.</p>
            {% endif %}
        </div>
    </details>

</div>

{% else %}
<!-- No task assigned -->
<div class="content-card text-center">
    <p class="text-muted">Kein Thema zugewiesen.</p>
    <a href="{{ url_for('student_dashboard') }}" class="btn btn-primary mt-1">â† ZurÃ¼ck zum Dashboard</a>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
const topicSlug = '{{ task.name|slugify }}';
const subtaskCount = {{ subtasks|length }};

function toggleSubtask(position, checked) {
    const csrfToken = document.querySelector('meta[name="csrf-token"]').content;

    // Disable checkbox during request
    const checkboxes = document.querySelectorAll('.subtask-checkbox');
    checkboxes.forEach(cb => cb.disabled = true);

    fetch(`/schueler/thema/${topicSlug}/aufgabe/${position}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({erledigt: checked})
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.show_quiz && data.quiz_url) {
            window.location.href = data.quiz_url;
            return;
        }

        if (checked) {
            const successBanner = document.getElementById('success-banner');
            if (successBanner) {
                successBanner.style.display = 'flex';
            }

            // Update progress dot
            const currentDot = document.querySelector('.progress-dots .dot.current');
            if (currentDot) {
                currentDot.classList.add('completed');
            }

            updateProgressText();
        } else {
            // Unchecking - reload page to reset state
            setTimeout(() => {
                window.location.href = window.location.href;
            }, 100);
        }
    })
    .catch(err => {
        console.error('Error toggling subtask:', err);
        checkboxes.forEach(cb => cb.disabled = false);
        alert(`Fehler beim Speichern: ${err.message}\nBitte versuche es erneut oder lade die Seite neu.`);
    });
}

function updateProgressText() {
    const allDots = document.querySelectorAll('.progress-dots .dot.dot-subtask');
    const requiredDots = Array.from(allDots).filter(d => d.dataset.required !== 'false');
    const completedRequired = requiredDots.filter(d => d.classList.contains('completed'));
    const progressText = document.getElementById('progress-text');

    if (progressText) {
        progressText.textContent = `${completedRequired.length} von ${requiredDots.length} Aufgaben erledigt`;
    }
}

function goToNextSubtask(currentIndex) {
    if (currentIndex < subtaskCount - 1) {
        const url = new URL(window.location);
        url.searchParams.set('aufgabe', currentIndex + 2);
        window.location.href = url.toString();
    } else {
        const quizDot = document.querySelector('.dot-quiz');
        if (quizDot) {
            navigateToQuiz(false);
        }
    }
}

function goToPrevSubtask(currentIndex) {
    if (currentIndex > 0) {
        const url = new URL(window.location);
        url.searchParams.set('aufgabe', currentIndex);
        window.location.href = url.toString();
    }
}

function navigateToSubtask(position) {
    const url = new URL(window.location);
    url.searchParams.set('aufgabe', position);
    window.location.href = url.toString();
}

function navigateToQuiz(passed) {
    if (passed) {
        window.location.href = `/schueler/thema/${topicSlug}/quiz-ergebnis`;
    } else {
        window.location.href = `/schueler/thema/${topicSlug}/quiz`;
    }
}

function navigateToSubtaskQuiz(position, passed, available) {
    if (passed) {
        window.location.href = `/schueler/thema/${topicSlug}/aufgabe-${position}/quiz-ergebnis`;
    } else if (available) {
        window.location.href = `/schueler/thema/${topicSlug}/aufgabe-${position}/quiz`;
    }
    // locked (not available) â€” do nothing
}

// Keyboard navigation for all dots (WCAG 2.1)
function handleDotKeydown(event) {
    if (event.key === 'Enter' || event.key === ' ') {
        event.preventDefault();
        event.target.click();
    } else if (event.key === 'ArrowLeft' || event.key === 'ArrowRight') {
        event.preventDefault();
        const dots = Array.from(document.querySelectorAll('.progress-dots .dot'));
        const currentIndex = dots.indexOf(event.target);

        let nextIndex;
        if (event.key === 'ArrowLeft') {
            nextIndex = currentIndex > 0 ? currentIndex - 1 : dots.length - 1;
        } else {
            nextIndex = currentIndex < dots.length - 1 ? currentIndex + 1 : 0;
        }

        dots[nextIndex].focus();
    }
}

// Smooth scroll to element on page load if hash is present
window.addEventListener('DOMContentLoaded', function() {
    if (window.location.hash) {
        const element = document.querySelector(window.location.hash);
        if (element) {
            setTimeout(function() {
                element.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 100);
        }
    }
});
{% endblock %}
