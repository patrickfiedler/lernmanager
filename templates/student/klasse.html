{% extends 'base.html' %}

{% block title %}{{ klasse.name }} - Lernmanager{% endblock %}

{% block content %}
<!-- Breadcrumb Navigation -->
<div class="breadcrumb-nav mb-2">
    <a href="{{ url_for('student_dashboard') }}">Dashboard</a>
    <span class="separator">‚Ä∫</span>
    <span>{{ klasse.name }}</span>
</div>

{% if task %}
<!-- Main Content Card (contains everything) -->
<div class="content-card">

    <!-- Topic Headline -->
    <h1 class="topic-headline">{{ task.name }}</h1>
    <div class="topic-meta">{{ task.fach }} ¬∑ {{ task.stufe }}</div>

    <!-- Purpose Banner (Why learn this?) -->
    {% if task.why_learn_this %}
    <div class="purpose">
        <div class="purpose-icon">üí°</div>
        <div>
            <div class="purpose-label">Wof√ºr brauchst du das?</div>
            {{ task.why_learn_this }}
        </div>
    </div>
    {% endif %}

    <!-- Progress Section with Dots -->
    {% if all_subtasks %}
    <div class="progress-section">
        <div class="progress-header">
            <div class="progress-text" id="progress-text">
                {{ all_subtasks|selectattr('erledigt')|list|length }} von {{ all_subtasks|length }} Aufgaben erledigt
            </div>
            <div class="progress-dots">
                {% for sub in all_subtasks %}
                <div class="dot {% if sub.erledigt %}completed{% elif current_subtask and sub.id == current_subtask.id %}current{% endif %}"
                     data-subtask-index="{{ loop.index0 }}"></div>
                {% endfor %}
                {% if task.quiz_json %}
                <div class="dot dot-quiz {% if task.quiz_bestanden %}completed{% endif %}"
                     title="Quiz" data-is-quiz="true">?</div>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Success Banner (hidden initially, shown after completing task) -->
    <div class="success-banner" id="success-banner" style="display: none;">
        <span class="success-icon">‚úì</span>
        <div>Gut gemacht! Aufgabe erledigt.</div>
    </div>

    <!-- Current Task/Subtask -->
    {% if current_subtask or subtasks %}
    <div class="current-task">
        {% if current_subtask %}
        <!-- Show current subtask -->
        <div class="task-badge">Aufgabe {{ current_subtask.reihenfolge + 1 }} von {{ all_subtasks|length }}</div>
        {% elif subtasks %}
        <!-- Legacy mode: show first uncompleted -->
        {% set first_uncompleted = subtasks|rejectattr('erledigt')|list|first %}
        {% if first_uncompleted %}
        <div class="task-badge">Aktuelle Aufgabe</div>
        {% endif %}
        {% endif %}

        <div class="task-content markdown-content">
            {% if current_subtask %}
            {{ current_subtask.beschreibung | markdown }}
            {% elif subtasks %}
            {% set first_uncompleted = subtasks|rejectattr('erledigt')|list|first %}
            {% if first_uncompleted %}
            {{ first_uncompleted.beschreibung | markdown }}
            {% endif %}
            {% endif %}
        </div>

        <!-- Checkbox to mark complete -->
        {% set active_subtask = current_subtask or (subtasks|rejectattr('erledigt')|list|first) %}
        {% if active_subtask and not task.abgeschlossen %}
        <div class="task-complete" onclick="document.getElementById('subtask-checkbox-{{ active_subtask.id }}').click()">
            <input type="checkbox"
                   id="subtask-checkbox-{{ active_subtask.id }}"
                   class="subtask-checkbox"
                   {% if active_subtask.erledigt %}checked{% endif %}
                   onchange="toggleSubtask({{ task.id }}, {{ active_subtask.id }}, this.checked)"
                   onclick="event.stopPropagation()">
            <label for="subtask-checkbox-{{ active_subtask.id }}">Als erledigt markieren</label>
        </div>
        {% endif %}
    </div>

    <!-- Next Button (hidden initially, shown after marking complete) -->
    <button class="action-button" id="next-button" style="display: none;" onclick="goToNextSubtask()">
        Weiter zur n√§chsten Aufgabe ‚Üí
    </button>

    <!-- Completed Subtasks (collapsible) -->
    {% if completed_subtasks %}
    <details class="completed-tasks-toggle mt-2">
        <summary>‚úì {{ completed_subtasks|length }} Aufgabe(n) bereits erledigt</summary>
        <div class="completed-tasks-content">
            {% for sub in completed_subtasks %}
            <div class="completed-task-item">
                <span class="check-icon">‚úì</span>
                <div class="completed-task-text">{{ sub.beschreibung[:100] }}{% if sub.beschreibung|length > 100 %}...{% endif %}</div>
            </div>
            {% endfor %}
        </div>
    </details>
    {% endif %}

    {% else %}
    <p class="text-muted">Keine Aufgaben definiert.</p>
    {% endif %}

    <!-- Materials Section (collapsible, default open) -->
    {% if materials %}
    <details class="materials-toggle mt-2" open>
        <summary>üìé Materialien</summary>
        <div class="materials-content">
            <ul class="material-list">
                {% for mat in materials %}
                <li class="material-item">
                    {% if mat.typ == 'link' %}
                    <span class="material-icon">üîó</span>
                    <a href="{{ mat.pfad }}" target="_blank">{{ mat.beschreibung or mat.pfad }}</a>
                    {% else %}
                    <span class="material-icon">üìÑ</span>
                    <a href="{{ url_for('download_material', material_id=mat.id) }}" target="_blank">{{ mat.beschreibung or mat.pfad }}</a>
                    {% endif %}
                </li>
                {% endfor %}
            </ul>
        </div>
    </details>
    {% endif %}

    <!-- Quiz Section (if all subtasks complete) -->
    {% if task.quiz_json %}
    {% set all_complete = (all_subtasks|selectattr('erledigt')|list|length == all_subtasks|length) %}
    {% if all_complete and not task.abgeschlossen %}
    <div class="quiz-card mt-2">
        <div class="quiz-header">‚ùì Quiz</div>
        {% if quiz_attempts %}
        <div class="quiz-attempts">
            <p><strong>Bisherige Versuche:</strong></p>
            {% for attempt in quiz_attempts[:3] %}
            <div class="quiz-attempt">
                {{ attempt.timestamp[:10] }}: {{ attempt.punkte }}/{{ attempt.max_punkte }} Punkte
                {% if attempt.bestanden %}
                <span class="badge badge-success">‚úÖ Bestanden</span>
                {% else %}
                <span class="badge badge-danger">‚ùå Nicht bestanden</span>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        {% endif %}
        <a href="{{ url_for('student_quiz', student_task_id=task.id) }}" class="btn btn-primary mt-1">Quiz starten</a>
        <p class="text-muted mt-1"><small>Du brauchst mindestens 80% richtige Antworten zum Bestehen.</small></p>
    </div>
    {% elif task.abgeschlossen %}
    <div class="alert alert-success mt-2">
        ‚úÖ Quiz bestanden! Thema abgeschlossen.
    </div>
    {% endif %}
    {% endif %}

    <!-- Topic Description (expandable, at bottom) -->
    <details class="topic-description-toggle mt-2">
        <summary>Ausf√ºhrliche Beschreibung</summary>
        <div class="topic-description-content">
            {% if task.lernziel %}
            <div class="mb-1">
                <strong>üéØ Lernziel:</strong>
                <div class="markdown-content">{{ task.lernziel | markdown }}</div>
            </div>
            {% endif %}
            {% if task.beschreibung %}
            <div>
                <strong>üìã Beschreibung:</strong>
                <div class="markdown-content">{{ task.beschreibung | markdown }}</div>
            </div>
            {% endif %}
            {% if not task.lernziel and not task.beschreibung %}
            <p class="text-muted">Keine zus√§tzlichen Informationen verf√ºgbar.</p>
            {% endif %}
        </div>
    </details>

</div>

{% else %}
<!-- No task assigned -->
<div class="content-card text-center">
    <p class="text-muted">Kein Thema zugewiesen.</p>
    <a href="{{ url_for('student_dashboard') }}" class="btn btn-primary mt-1">‚Üê Zur√ºck zum Dashboard</a>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
function toggleSubtask(studentTaskId, subtaskId, checked) {
    const csrfToken = document.querySelector('meta[name="csrf-token"]').content;

    fetch(`/schueler/aufgabe/${studentTaskId}/teilaufgabe/${subtaskId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({erledigt: checked})
    }).then(r => r.json()).then(data => {
        if (checked) {
            // Show success banner and next button
            const successBanner = document.getElementById('success-banner');
            const nextButton = document.getElementById('next-button');

            if (successBanner) {
                successBanner.style.display = 'flex';
            }
            if (nextButton) {
                nextButton.style.display = 'inline-block';
            }

            // Update progress dot
            const dots = document.querySelectorAll('.progress-dots .dot:not(.dot-quiz)');
            const currentDot = document.querySelector('.progress-dots .dot.current');
            if (currentDot) {
                currentDot.classList.remove('current');
                currentDot.classList.add('completed');
            }

            // Update progress text
            updateProgressText();
        } else {
            // Unchecking - reload page to reset state
            location.reload();
        }
    }).catch(err => {
        console.error('Error toggling subtask:', err);
        alert('Fehler beim Speichern. Bitte versuche es erneut.');
    });
}

function updateProgressText() {
    const dots = document.querySelectorAll('.progress-dots .dot:not(.dot-quiz)');
    const completedDots = document.querySelectorAll('.progress-dots .dot.completed:not(.dot-quiz)');
    const progressText = document.getElementById('progress-text');

    if (progressText) {
        progressText.textContent = `${completedDots.length} von ${dots.length} Aufgaben erledigt`;
    }
}

function goToNextSubtask() {
    // Reload page to show next subtask
    // The backend will automatically show the next uncompleted subtask
    location.reload();
}

// Smooth scroll to element on page load if hash is present
window.addEventListener('DOMContentLoaded', function() {
    if (window.location.hash) {
        const element = document.querySelector(window.location.hash);
        if (element) {
            setTimeout(function() {
                element.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 100);
        }
    }
});
</script>
{% endblock %}
