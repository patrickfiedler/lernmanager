{% extends 'base.html' %}

{% block title %}{{ klasse.name }} - Lernmanager{% endblock %}

{% block content %}
<!-- Breadcrumb Navigation -->
<div class="breadcrumb-nav mb-2">
    <a href="{{ url_for('student_dashboard') }}">Dashboard</a>
    <span class="separator">‚Ä∫</span>
    <span>{{ klasse.name }}</span>
</div>

{% if task %}
<!-- Main Content Card (contains everything) -->
<div class="content-card">

    <!-- Topic Headline -->
    <h1 class="topic-headline">{{ task.name }}</h1>
    <div class="topic-meta">{{ task.fach }} ¬∑ {{ task.stufe }}</div>

    <!-- Purpose Banner (Why learn this?) -->
    {% if task.why_learn_this %}
    <div class="purpose">
        <div class="purpose-icon">üí°</div>
        <div>
            <div class="purpose-label">Wof√ºr brauchst du das?</div>
            {{ task.why_learn_this }}
        </div>
    </div>
    {% endif %}

    <!-- Progress Section with Dots (Q5A: based on visible subtasks only) -->
    {% if subtasks %}
    <div class="progress-section">
        <div class="progress-header">
            <div class="progress-text" id="progress-text">
                {{ subtasks|selectattr('erledigt')|list|length }} von {{ subtasks|length }} Aufgaben erledigt
            </div>
            <div class="progress-dots" role="group" aria-label="Aufgabenfortschritt">
                {% for sub in subtasks %}
                <div class="dot {% if sub.erledigt %}completed {% endif %}{% if current_subtask and sub.id == current_subtask.id %}current{% endif %}"
                     role="button"
                     tabindex="0"
                     aria-label="Aufgabe {{ loop.index }}: {{ sub.beschreibung[:50] }}{% if sub.beschreibung|length > 50 %}...{% endif %}{% if sub.erledigt %} - Erledigt{% endif %}"
                     {% if current_subtask and sub.id == current_subtask.id %}aria-current="true"{% endif %}
                     data-subtask-index="{{ loop.index0 }}"
                     data-subtask-id="{{ sub.id }}"
                     onclick="navigateToSubtask({{ sub.id }})"
                     onkeydown="handleDotKeydown(event, {{ sub.id }})"
                     title="Aufgabe {{ loop.index }}: {{ sub.beschreibung[:30] }}{% if sub.beschreibung|length > 30 %}...{% endif %}"></div>
                {% endfor %}
                {% if task.quiz_json %}
                <div class="dot dot-quiz {% if task.quiz_bestanden %}completed{% endif %}"
                     role="button"
                     tabindex="0"
                     aria-label="Quiz{% if task.quiz_bestanden %} - Bestanden{% endif %}"
                     title="Quiz"
                     data-is-quiz="true"
                     onclick="navigateToQuiz()"
                     onkeydown="handleQuizKeydown(event)">?</div>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Current Task/Subtask with Side Navigation -->
    {% if current_subtask or subtasks %}
    {% set active_subtask = current_subtask or (subtasks|rejectattr('erledigt')|list|first) %}
    {% set current_index = subtasks.index(active_subtask) if active_subtask and active_subtask in subtasks else 0 %}
    {% set has_prev = current_index > 0 %}
    {% set has_next = current_index < (subtasks|length - 1) or (current_index == (subtasks|length - 1) and task.quiz_json) %}

    <div class="task-navigation-wrapper">
        <!-- Desktop: Left Button -->
        <button class="nav-button-side nav-prev {% if not has_prev %}nav-disabled{% endif %}"
                onclick="goToPrevSubtask({{ current_index }})"
                {% if not has_prev %}disabled{% endif %}>
            <span class="nav-arrow">‚Üê</span>
            <span class="nav-label">Zur√ºck</span>
        </button>

        <!-- Content (shows first on mobile, center on desktop) -->
        <div class="current-task">
            {% if active_subtask %}
            <div class="task-badge-group">
                <div class="task-badge">Aufgabe {{ current_index + 1 }} von {{ subtasks|length }}</div>
                {% if active_subtask.estimated_minutes %}
                <div class="task-badge time-estimate">‚è±Ô∏è ~{{ active_subtask.estimated_minutes }} Min</div>
                {% else %}
                <div class="task-badge time-estimate">‚è±Ô∏è ~15-30 Min</div>
                {% endif %}
            </div>
            {% endif %}

            <div class="task-content markdown-content">
                {% if active_subtask %}
                {{ active_subtask.beschreibung | markdown }}
                {% endif %}
            </div>

            <!-- Checkbox to mark complete -->
            {% if active_subtask and not task.abgeschlossen %}
            <div class="task-complete" onclick="document.getElementById('subtask-checkbox-{{ active_subtask.id }}').click()">
                <input type="checkbox"
                       id="subtask-checkbox-{{ active_subtask.id }}"
                       class="subtask-checkbox"
                       {% if active_subtask.erledigt %}checked{% endif %}
                       onchange="toggleSubtask({{ task.id }}, {{ active_subtask.id }}, this.checked)"
                       onclick="event.stopPropagation()">
                <label for="subtask-checkbox-{{ active_subtask.id }}">Ich habe das geschafft! ‚úì</label>
            </div>
            {% endif %}

            <!-- Success Banner (hidden initially, shown after completing task) -->
            <div class="success-banner" id="success-banner" style="display: none;">
                <span class="success-icon">‚úì</span>
                <div>Gut gemacht! Aufgabe erledigt.</div>
            </div>
        </div>

        <!-- Desktop: Right Button -->
        <button class="nav-button-side nav-next {% if not has_next %}nav-disabled{% endif %}"
                onclick="goToNextSubtask({{ current_index }})"
                {% if not has_next %}disabled{% endif %}>
            <span class="nav-arrow">‚Üí</span>
            <span class="nav-label">Weiter</span>
        </button>

        <!-- Mobile: Button wrapper (appears after content) -->
        <div class="nav-buttons-mobile">
            <button class="nav-button-side nav-prev {% if not has_prev %}nav-disabled{% endif %}"
                    onclick="goToPrevSubtask({{ current_index }})"
                    {% if not has_prev %}disabled{% endif %}>
                <span class="nav-arrow">‚Üê</span>
                <span class="nav-label">Zur√ºck</span>
            </button>
            <button class="nav-button-side nav-next {% if not has_next %}nav-disabled{% endif %}"
                    onclick="goToNextSubtask({{ current_index }})"
                    {% if not has_next %}disabled{% endif %}>
                <span class="nav-arrow">‚Üí</span>
                <span class="nav-label">Weiter</span>
            </button>
        </div>
    </div>


    <!-- Completed Subtasks (collapsible) -->
    {% if completed_subtasks %}
    <details class="completed-tasks-toggle mt-2">
        <summary>‚úì {{ completed_subtasks|length }} Aufgabe(n) bereits erledigt</summary>
        <div class="completed-tasks-content">
            {% for sub in completed_subtasks %}
            <div class="completed-task-item">
                <span class="check-icon">‚úì</span>
                <div class="completed-task-text">{{ sub.beschreibung[:100] }}{% if sub.beschreibung|length > 100 %}...{% endif %}</div>
            </div>
            {% endfor %}
        </div>
    </details>
    {% endif %}

    {% else %}
    <!-- Q3B: Encouraging Empty State -->
    <div class="empty-state-card">
        <div class="empty-state-icon">‚ú®</div>
        <h2 class="empty-state-title">Weitere Aufgaben kommen bald!</h2>
        <p class="empty-state-text">Dein Lehrer bereitet sie vor.</p>
    </div>
    {% endif %}

    <!-- Materials Section (collapsible, default open) -->
    {% if materials %}
    <details class="materials-toggle mt-2" open>
        <summary>üìé Materialien</summary>
        <div class="materials-content">
            <ul class="material-list">
                {% for mat in materials %}
                <li class="material-item">
                    {% if mat.typ == 'link' %}
                    <span class="material-icon">üîó</span>
                    <a href="{{ mat.pfad }}" target="_blank">{{ mat.beschreibung or mat.pfad }}</a>
                    {% else %}
                    <span class="material-icon">üìÑ</span>
                    <a href="{{ url_for('download_material', material_id=mat.id) }}" target="_blank">{{ mat.beschreibung or mat.pfad }}</a>
                    {% endif %}
                </li>
                {% endfor %}
            </ul>
        </div>
    </details>
    {% endif %}

    <!-- Quiz Section (if all subtasks complete) -->
    {% if task.quiz_json %}
    {% set all_complete = (all_subtasks|selectattr('erledigt')|list|length == all_subtasks|length) %}
    {% if all_complete and not task.abgeschlossen %}
    <div class="quiz-card mt-2">
        <div class="quiz-header">‚ùì Quiz</div>
        {% if quiz_attempts %}
        <div class="quiz-attempts">
            <p><strong>Bisherige Versuche:</strong></p>
            {% for attempt in quiz_attempts[:3] %}
            <div class="quiz-attempt">
                {{ attempt.timestamp[:10] }}: {{ attempt.punkte }}/{{ attempt.max_punkte }} Punkte
                {% if attempt.bestanden %}
                <span class="badge badge-success">‚úÖ Bestanden</span>
                {% else %}
                <span class="badge badge-danger">‚ùå Nicht bestanden</span>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        {% endif %}
        <a href="{{ url_for('student_quiz', student_task_id=task.id) }}" class="btn btn-primary mt-1">Quiz starten</a>
        <p class="text-muted mt-1"><small>Du brauchst mindestens 80% richtige Antworten zum Bestehen.</small></p>
    </div>
    {% elif task.abgeschlossen %}
    <div class="alert alert-success mt-2">
        ‚úÖ Quiz bestanden! Thema abgeschlossen.
    </div>
    {% endif %}
    {% endif %}

    <!-- Topic Description (expandable, at bottom) -->
    <details class="topic-description-toggle mt-2">
        <summary>Ausf√ºhrliche Beschreibung</summary>
        <div class="topic-description-content">
            {% if task.lernziel %}
            <div class="mb-1">
                <strong>üéØ Lernziel:</strong>
                <div class="markdown-content">{{ task.lernziel | markdown }}</div>
            </div>
            {% endif %}
            {% if task.beschreibung %}
            <div>
                <strong>üìã Beschreibung:</strong>
                <div class="markdown-content">{{ task.beschreibung | markdown }}</div>
            </div>
            {% endif %}
            {% if not task.lernziel and not task.beschreibung %}
            <p class="text-muted">Keine zus√§tzlichen Informationen verf√ºgbar.</p>
            {% endif %}
        </div>
    </details>

</div>

{% else %}
<!-- No task assigned -->
<div class="content-card text-center">
    <p class="text-muted">Kein Thema zugewiesen.</p>
    <a href="{{ url_for('student_dashboard') }}" class="btn btn-primary mt-1">‚Üê Zur√ºck zum Dashboard</a>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
function toggleSubtask(studentTaskId, subtaskId, checked) {
    const csrfToken = document.querySelector('meta[name="csrf-token"]').content;

    // Disable checkbox during request
    const checkbox = document.getElementById(`subtask-checkbox-${subtaskId}`);
    if (checkbox) {
        checkbox.disabled = true;
    }

    fetch(`/schueler/aufgabe/${studentTaskId}/teilaufgabe/${subtaskId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({erledigt: checked})
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (checked) {
            // Show success banner
            const successBanner = document.getElementById('success-banner');
            if (successBanner) {
                successBanner.style.display = 'flex';
            }

            // Update progress dot
            const dots = document.querySelectorAll('.progress-dots .dot:not(.dot-quiz)');
            const currentDot = document.querySelector('.progress-dots .dot.current');
            if (currentDot) {
                // Keep 'current' class, just add 'completed' class too
                // Both classes together = green dot with border ring
                currentDot.classList.add('completed');
            }

            // Update progress text
            updateProgressText();
        } else {
            // Unchecking - reload page to reset state (to reset state)
            // Preserve current subtask_id parameter to stay on same task
            setTimeout(() => {
                const url = new URL(window.location);
                // Note: subtask_id already in URL, so it's preserved
                window.location.href = url.toString();
            }, 100);
        }
    })
    .catch(err => {
        console.error('Error toggling subtask:', err);
        // Re-enable and reset checkbox on error
        if (checkbox) {
            checkbox.disabled = false;
            checkbox.checked = !checked;  // Revert to previous state
        }
        alert(`Fehler beim Speichern: ${err.message}\nBitte versuche es erneut oder lade die Seite neu.`);
    });
}

function updateProgressText() {
    const dots = document.querySelectorAll('.progress-dots .dot:not(.dot-quiz)');
    const completedDots = document.querySelectorAll('.progress-dots .dot.completed:not(.dot-quiz)');
    const progressText = document.getElementById('progress-text');

    if (progressText) {
        progressText.textContent = `${completedDots.length} von ${dots.length} Aufgaben erledigt`;
    }
}

// Navigation: Build subtask ID array from template
const subtaskIds = [{% for sub in subtasks %}{{ sub.id }}{% if not loop.last %}, {% endif %}{% endfor %}];
const completedIds = new Set([{% for sub in completed_subtasks %}{{ sub.id }}{% if not loop.last %}, {% endif %}{% endfor %}]);

function goToNextSubtask(currentIndex) {
    // Navigate to next subtask in sequence (handles gaps in numbering)
    if (currentIndex < subtaskIds.length - 1) {
        const nextSubtaskId = subtaskIds[currentIndex + 1];
        const url = new URL(window.location);
        url.searchParams.set('subtask_id', nextSubtaskId);
        window.location.href = url.toString();
    } else {
        // On last subtask - check if there's a quiz
        const quizDot = document.querySelector('.dot-quiz');
        if (quizDot) {
            navigateToQuiz();
        }
    }
}

function goToPrevSubtask(currentIndex) {
    // Navigate to previous subtask in sequence
    if (currentIndex > 0) {
        const prevSubtaskId = subtaskIds[currentIndex - 1];
        const url = new URL(window.location);
        url.searchParams.set('subtask_id', prevSubtaskId);
        window.location.href = url.toString();
    }
}

function navigateToSubtask(subtaskId) {
    // Navigate to specific subtask by clicking its dot
    const url = new URL(window.location);
    url.searchParams.set('subtask_id', subtaskId);
    window.location.href = url.toString();
}

function navigateToQuiz() {
    // Navigate to quiz page
    window.location.href = `/schueler/aufgabe/{{ task.id }}/quiz`;
}

// Keyboard navigation for progress dots (WCAG 2.1 keyboard accessibility)
function handleDotKeydown(event, subtaskId) {
    // Enter or Space = click the dot
    if (event.key === 'Enter' || event.key === ' ') {
        event.preventDefault();
        navigateToSubtask(subtaskId);
    }
    // Arrow keys = navigate between dots
    else if (event.key === 'ArrowLeft' || event.key === 'ArrowRight') {
        event.preventDefault();
        const dots = Array.from(document.querySelectorAll('.progress-dots .dot'));
        const currentIndex = dots.indexOf(event.target);

        let nextIndex;
        if (event.key === 'ArrowLeft') {
            nextIndex = currentIndex > 0 ? currentIndex - 1 : dots.length - 1;
        } else {
            nextIndex = currentIndex < dots.length - 1 ? currentIndex + 1 : 0;
        }

        dots[nextIndex].focus();
    }
}

function handleQuizKeydown(event) {
    // Enter or Space = navigate to quiz
    if (event.key === 'Enter' || event.key === ' ') {
        event.preventDefault();
        navigateToQuiz();
    }
    // Arrow keys = navigate to adjacent dots
    else if (event.key === 'ArrowLeft' || event.key === 'ArrowRight') {
        event.preventDefault();
        const dots = Array.from(document.querySelectorAll('.progress-dots .dot'));
        const currentIndex = dots.indexOf(event.target);

        let nextIndex;
        if (event.key === 'ArrowLeft') {
            nextIndex = currentIndex > 0 ? currentIndex - 1 : dots.length - 1;
        } else {
            nextIndex = currentIndex < dots.length - 1 ? currentIndex + 1 : 0;
        }

        dots[nextIndex].focus();
    }
}

// Smooth scroll to element on page load if hash is present
window.addEventListener('DOMContentLoaded', function() {
    if (window.location.hash) {
        const element = document.querySelector(window.location.hash);
        if (element) {
            setTimeout(function() {
                element.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 100);
        }
    }
});
{% endblock %}
