{% extends 'base.html' %}

{% block title %}Quiz Ergebnis - Lernmanager{% endblock %}

{% block content %}
<div class="text-center mb-2">
    {% if bestanden %}
    <h1>ğŸ‰ Bestanden!</h1>
    <p class="text-success" style="font-size: 1.5rem;">Du hast {{ punkte }} von {{ max_punkte }} Punkten erreicht.</p>
    {% else %}
    <h1>ğŸ’ª Fast geschafft!</h1>
    <p style="font-size: 1.5rem;">Du hast {{ punkte }} von {{ max_punkte }} Punkten erreicht.</p>
    {% set prozent = ((punkte / max_punkte) * 100)|int %}
    <p>Du brauchst mindestens 70% ({{ (max_punkte * 0.7)|round(0, 'ceil')|int }} Punkte) zum Bestehen.</p>

    {% if previous_attempt %}
        {% set previous_prozent = ((previous_attempt.punkte / previous_attempt.max_punkte) * 100)|int %}
        {% if prozent > previous_prozent %}
        <div class="alert alert-success" style="margin-top: 1rem;">
            â­ Du wirst besser! Beim letzten Mal: {{ previous_attempt.punkte }}/{{ previous_attempt.max_punkte }} ({{ previous_prozent }}%).
            Jetzt: {{ punkte }}/{{ max_punkte }} ({{ prozent }}%). Weiter so! ğŸ’ª
        </div>
        {% elif prozent == previous_prozent %}
        <div class="alert alert-info" style="margin-top: 1rem;">
            Du hast die gleiche Punktzahl wie beim letzten Mal. Schau dir die Antworten unten an und versuche es noch einmal!
        </div>
        {% endif %}
    {% else %}
        <p style="margin-top: 1rem;">Schau dir die richtigen Antworten unten an und versuche es noch einmal! Du schaffst das! ğŸš€</p>
    {% endif %}
    {% endif %}
</div>

<div class="card mb-2">
    <div class="card-header">ğŸ“Š Deine Antworten</div>
    {% for question in quiz.questions %}
    <div class="quiz-question">
        <h4>Frage {{ loop.index }}: {{ question.question }}</h4>
        {% if question.image %}
        <img src="{{ question.image }}" alt="Bild zur Frage {{ loop.index }}" class="quiz-question-image">
        {% endif %}
        {% set q_idx = loop.index0|string %}
        {% set user_answer = antworten.get(q_idx, []) %}

        {% if question.type in ['fill_blank', 'short_answer'] %}
        {# Free-text answer with LLM feedback #}
        {% if user_answer is mapping %}
        <div class="quiz-option selected {% if user_answer.correct %}text-success{% else %}text-danger{% endif %}" style="border-left: 4px solid {% if user_answer.correct %}var(--success-color, #28a745){% else %}var(--danger-color, #dc3545){% endif %}; padding-left: 1rem;">
            <strong>Deine Antwort:</strong> {{ user_answer.text or '(keine Antwort)' }}
        </div>
        {% if user_answer.feedback %}
        <div class="quiz-option" style="border-left: 4px solid {% if user_answer.source == 'fallback' %}var(--warning-color, #ffc107){% else %}var(--info-color, #17a2b8){% endif %}; padding-left: 1rem; background: {% if user_answer.source == 'fallback' %}#fff8e1{% else %}#e8f4fd{% endif %};">
            ğŸ’¬ {{ user_answer.feedback }}
        </div>
        {% endif %}
        {% endif %}
        {% else %}
        {# Multiple choice (default) â€” show selected options #}
        {% for answer in question.answers %}
        {% set was_selected = loop.index0 in user_answer %}
        <div class="quiz-option {% if was_selected %}selected{% endif %}">
            {% if was_selected %}â—{% else %}â—‹{% endif %}
            {% if answer is mapping %}
            <span>{{ answer.text }}</span>
            {% if answer.image %}<img src="{{ answer.image }}" alt="{{ answer.text }}" class="quiz-option-image">{% endif %}
            {% else %}
            <span>{{ answer }}</span>
            {% endif %}
        </div>
        {% endfor %}
        {% endif %}
    </div>
    {% endfor %}
</div>

<div class="flex gap-1">
    {% if not bestanden %}
    <a href="{{ url_for('student_quiz', student_task_id=task.id, subtask_id=subtask_id) }}" class="btn btn-primary">ğŸ”„ Erneut versuchen</a>
    {% endif %}
    {% if subtask_id and klasse_id %}
    <a href="{{ url_for('student_klasse', klasse_id=klasse_id) }}" class="btn btn-secondary">â† ZurÃ¼ck zur Aufgabe</a>
    {% else %}
    <a href="{{ url_for('student_dashboard') }}" class="btn btn-secondary">â† ZurÃ¼ck</a>
    {% endif %}
</div>
{% endblock %}
