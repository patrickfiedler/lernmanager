{% extends 'base.html' %}

{% block title %}Quiz Ergebnis - Lernmanager{% endblock %}

{% block content %}
<div class="text-center mb-2">
    {% if bestanden %}
    <h1>ğŸ‰ Bestanden!</h1>
    <p class="text-success" style="font-size: 1.5rem;">Du hast {{ punkte }} von {{ max_punkte }} Punkten erreicht.</p>
    {% else %}
    <h1>ğŸ’ª Fast geschafft!</h1>
    <p style="font-size: 1.5rem;">Du hast {{ punkte }} von {{ max_punkte }} Punkten erreicht.</p>
    {% set prozent = ((punkte / max_punkte) * 100)|int %}
    {% set min_richtig = [1, (max_punkte * 0.7)|int]|max %}
    <p>Du brauchst mindestens {{ min_richtig }} von {{ max_punkte }} richtigen Antworten zum Bestehen.</p>

    {% if previous_attempt %}
        {% set previous_prozent = ((previous_attempt.punkte / previous_attempt.max_punkte) * 100)|int %}
        {% if prozent > previous_prozent %}
        <div class="alert alert-success" style="margin-top: 1rem;">
            â­ Du wirst besser! Beim letzten Mal: {{ previous_attempt.punkte }}/{{ previous_attempt.max_punkte }} ({{ previous_prozent }}%).
            Jetzt: {{ punkte }}/{{ max_punkte }} ({{ prozent }}%). Weiter so! ğŸ’ª
        </div>
        {% elif prozent == previous_prozent %}
        <div class="alert alert-info" style="margin-top: 1rem;">
            Du hast die gleiche Punktzahl wie beim letzten Mal. Schau dir die Antworten unten an und versuche es noch einmal!
        </div>
        {% endif %}
    {% else %}
        <p style="margin-top: 1rem;">Schau dir die richtigen Antworten unten an und versuche es noch einmal! Du schaffst das! ğŸš€</p>
    {% endif %}
    {% endif %}
</div>

<div class="card mb-2">
    <div class="card-header">ğŸ“Š Deine Antworten</div>
    {% for question in quiz.questions %}
    <div class="quiz-question">
        <h4>Frage {{ loop.index }}: {{ question.question }}</h4>
        {% if question.image %}
        <img src="{{ question.image }}" alt="Bild zur Frage {{ loop.index }}" class="quiz-question-image">
        {% endif %}
        {% set q_idx = loop.index0|string %}
        {% set user_answer = antworten.get(q_idx, []) %}

        {% if question.type in ['fill_blank', 'short_answer'] %}
        {# Free-text answer with LLM feedback #}
        {% if user_answer is mapping %}
        <div class="quiz-option selected {% if user_answer.correct %}text-success{% else %}text-danger{% endif %}" style="border-left: 4px solid {% if user_answer.correct %}var(--success-color, #28a745){% else %}var(--danger-color, #dc3545){% endif %}; padding-left: 1rem;">
            {% if user_answer.correct %}âœ…{% else %}âŒ{% endif %} <strong>Deine Antwort:</strong> {{ user_answer.text or '(keine Antwort)' }}
        </div>
        {% if user_answer.feedback %}
        <div class="quiz-option" style="border-left: 4px solid {% if user_answer.source == 'fallback' %}var(--warning-color, #ffc107){% else %}var(--info-color, #17a2b8){% endif %}; padding-left: 1rem; background: {% if user_answer.source == 'fallback' %}#fff8e1{% else %}#e8f4fd{% endif %};">
            ğŸ’¬ {{ user_answer.feedback }}
        </div>
        {% endif %}
        {% endif %}
        {% else %}
        {# Multiple choice â€” show correct/incorrect per option #}
        {% set is_correct = (user_answer|sort == question.correct|sort) %}
        {% for answer in question.answers %}
        {% set was_selected = loop.index0 in user_answer %}
        {% set is_correct_option = loop.index0 in question.correct %}
        <div class="quiz-option" style="border-left: 4px solid {% if was_selected and is_correct_option %}var(--success-color, #28a745){% elif was_selected and not is_correct_option %}var(--danger-color, #dc3545){% elif is_correct_option %}var(--success-color, #28a745){% else %}var(--gray-200, #e5e7eb){% endif %}; padding-left: 1rem; {% if was_selected and is_correct_option %}background: #e8f5e9;{% elif was_selected and not is_correct_option %}background: #fde8e8;{% elif is_correct_option %}background: #e8f5e9; opacity: 0.7;{% endif %}">
            {% if is_correct_option %}âœ…{% elif was_selected %}âŒ{% endif %}
            {% if answer is mapping %}
            <span>{{ answer.text }}</span>
            {% if answer.image %}<img src="{{ answer.image }}" alt="{{ answer.text }}" class="quiz-option-image">{% endif %}
            {% else %}
            <span>{{ answer }}</span>
            {% endif %}
            {% if was_selected %}<span style="margin-left: auto; font-size: 0.8rem; color: {% if is_correct_option %}var(--success-color, #28a745){% else %}var(--danger-color, #dc3545){% endif %}; font-weight: 500;">Deine Antwort</span>{% endif %}
        </div>
        {% endfor %}
        <div class="quiz-option" style="border-left: 4px solid var(--info-color, #17a2b8); padding-left: 1rem; background: #e8f4fd;">
            ğŸ’¬ {% if is_correct %}Richtig!{% else %}Leider falsch.{% endif %}
        </div>
        {% endif %}
    </div>
    {% endfor %}
</div>

<div class="flex gap-1">
    {% if not bestanden %}
    <a href="{% if position %}{{ url_for('student_quiz_subtask', slug=slug, position=position) }}{% else %}{{ url_for('student_quiz', slug=slug) }}{% endif %}" class="btn btn-primary">ğŸ”„ Erneut versuchen</a>
    <a href="{{ url_for('student_klasse', slug=slug, aufgabe=position) if position else url_for('student_klasse', slug=slug) }}" class="btn btn-secondary">â† ZurÃ¼ck zur Aufgabe</a>
    {% elif position and next_position %}
    <a href="{{ url_for('student_klasse', slug=slug, aufgabe=next_position) }}" class="btn btn-primary">Zur nÃ¤chsten Aufgabe â†’</a>
    {% else %}
    <a href="{{ url_for('student_klasse', slug=slug) }}" class="btn btn-primary">Zum Thema â†’</a>
    {% endif %}
</div>
{% endblock %}
