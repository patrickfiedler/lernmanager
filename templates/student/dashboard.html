{% extends 'base.html' %}

{% block title %}Lernmanager{% endblock %}

{% block content %}
<div class="flex flex-between flex-center mb-2">
    <h1>Hallo, {{ student.vorname }}!</h1>
    <a href="{{ url_for('student_bericht') }}" class="btn btn-success">ğŸ“Š Mein Lernfortschritt</a>
</div>

{% if klassen %}
<div class="grid grid-2">
    {% for klasse in klassen %}
    {% set task = tasks_by_klasse.get(klasse.id) %}
    <div class="card task-card {% if task and task.abgeschlossen %}complete{% elif task and task.kategorie == 'bonus' %}bonus{% endif %}">
        {% if task %}
        <div class="card-header flex flex-between">
            <span>{% if task.kategorie == 'bonus' %}â­{% else %}ğŸ“š{% endif %} {{ task.name }}</span>
            <div class="flex gap-1">
                {% if task.abgeschlossen %}
                <span class="badge badge-success">âœ… Fertig</span>
                {% else %}
                <span class="badge badge-primary">ğŸ”„ In Arbeit</span>
                {% endif %}
            </div>
        </div>

        {% if task.kategorie == 'bonus' %}
        <span class="badge badge-warning mb-1">â­ Bonusthema</span>
        {% endif %}
        {% if student_path %}
        <span class="badge mb-1" style="{% if student_path == 'wanderweg' %}background: #dcfce7; color: #166534;{% elif student_path == 'bergweg' %}background: #dbeafe; color: #1e40af;{% else %}background: #fef3c7; color: #92400e;{% endif %}">
            {% if student_path == 'wanderweg' %}ğŸŸ¢ Wanderweg{% elif student_path == 'bergweg' %}ğŸ”µ Bergweg{% else %}â­ Gipfeltour{% endif %}
        </span>
        {% endif %}

        {% if task.next_task_preview %}
        <div class="mb-1 text-muted">ğŸ“ NÃ¤chste Aufgabe: {{ task.next_task_preview }}</div>
        {% elif task.abgeschlossen %}
        {% else %}
        <div class="mb-1 text-muted">ğŸ“ Alle Aufgaben erledigt</div>
        {% endif %}

        <!-- Progress -->
        {% if task.total_subtasks > 0 %}
        <div class="mb-1">
            <div class="flex flex-between mb-1">
                <span>Fortschritt</span>
                <span>{{ task.completed_subtasks }}/{{ task.total_subtasks }}</span>
            </div>
            <div class="progress-container">
                <div class="progress-bar {% if task.completed_subtasks == task.total_subtasks %}complete{% endif %}"
                     style="width: {{ (task.completed_subtasks / task.total_subtasks * 100) if task.total_subtasks > 0 else 0 }}%;"></div>
            </div>
        </div>
        {% endif %}

        <a href="{{ url_for('student_klasse', slug=task.name|slugify) }}" class="btn btn-primary">
            {% if task.abgeschlossen %}Details ansehen{% else %}Weiter lernen â†’{% endif %}
        </a>

        {% set nxt = next_topics.get(klasse.id) if next_topics else None %}
        {% if task.abgeschlossen and nxt %}
        <hr style="margin: 0.75rem 0; border-color: #e5e7eb;">
        <div>
            <div class="text-muted mb-1">ğŸ¯ NÃ¤chstes Thema: <strong>{{ nxt.name }}</strong></div>
            <form method="POST" action="{{ url_for('student_start_next_topic') }}" style="display: inline;">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="task_id" value="{{ nxt.task_id }}">
                <input type="hidden" name="klasse_id" value="{{ klasse.id }}">
                <button type="submit" class="btn btn-success">NÃ¤chstes Thema starten â†’</button>
            </form>
        </div>
        {% endif %}

        {% else %}

        {% set nxt = next_topics.get(klasse.id) if next_topics else None %}
        {% if nxt %}
        <div class="card-header">ğŸ¯ {{ nxt.name }}</div>
        <p class="text-muted mb-1">Dein nÃ¤chstes Thema ist bereit.</p>
        <form method="POST" action="{{ url_for('student_start_next_topic') }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="task_id" value="{{ nxt.task_id }}">
            <input type="hidden" name="klasse_id" value="{{ klasse.id }}">
            <button type="submit" class="btn btn-success">Thema starten â†’</button>
        </form>
        {% else %}
        <p class="text-muted">Kein Thema zugewiesen.</p>
        {% endif %}

        {% endif %}
    </div>

    {% for sq in sidequests_by_klasse.get(klasse.id, []) %}
    <div class="card task-card">
        <div class="card-header flex flex-between">
            <span>âš”ï¸ {{ sq.name }}</span>
            <span class="badge" style="background: #fef3c7; color: #92400e;">Sidequest</span>
        </div>
        <a href="{{ url_for('student_klasse', slug=sq.name|slugify) }}" class="btn btn-primary">Weiter lernen â†’</a>
    </div>
    {% endfor %}

    {% endfor %}
</div>

{% if has_warmup_pool %}
<div class="card mt-2">
    <div class="card-header">ğŸ§  Ãœben</div>
    <p class="text-muted mb-1">Wiederhole Fragen aus abgeschlossenen Themen.</p>
    <a href="{{ url_for('student_practice') }}" class="btn btn-secondary">Ãœbungsmodus starten</a>
</div>
{% endif %}

{% else %}
<div class="card text-center text-muted">
    <p>Du bist noch keiner Klasse zugeordnet.</p>
</div>
{% endif %}
{% endblock %}
